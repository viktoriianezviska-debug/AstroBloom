<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AstroBloom Interactive Globe</title>
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700&display=swap" rel="stylesheet">
<!-- Three.js + Globe.gl -->
<script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>
<script src="https://unpkg.com/globe.gl"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
html, body {
  height: 100%;
  margin: 0;
  font-family: 'Syne', sans-serif;
  background: #000;
  color: #eee;
  overflow: hidden;
}
.app {
  display: grid;
  grid-template-columns: 1fr 380px;
  height: 100vh;
  gap: 10px;
  padding: 10px;
  box-sizing: border-box;
}
.globe-wrap { position: relative; border-radius: 16px; overflow: hidden; box-shadow: 0 8px 30px rgba(0,0,0,0.7);}
#globeViz { width: 100%; height: 100%; display: block; }
.panel {
  background: rgba(10,10,12,0.95);
  border-radius: 16px;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  overflow-y: auto;
}
.controls .row { display:flex; align-items:center; gap:8px; }
input[type=range] { flex:1; }
.btn { padding:6px 12px; border:none; border-radius:8px; cursor:pointer; background:#ff1493; color:white; font-weight:600; }
.countries { display:grid; grid-template-columns: 1fr 1fr; gap:6px; }
.country-btn { padding:6px 8px; border-radius:8px; background:#111; cursor:pointer; color:#eee; font-weight:600; font-size:13px; }
.chart-wrap { height:200px; }
#tooltip { position:absolute; pointer-events:none; background:rgba(20,20,25,0.95); color:white; padding:6px 10px; border-radius:8px; display:none; font-size:13px; }
</style>
</head>
<body>
<div class="app">
  <div class="globe-wrap" id="globeWrap">
    <div id="globeViz"></div>
    <div id="tooltip"></div>
  </div>

  <div class="panel">
    <h2>AstroBloom — NDVI & Blooms</h2>
    <div class="controls">
      <div class="row">
        <label>Month:</label>
        <input type="range" id="monthSlider" min="0" max="11" value="0">
        <span id="monthLabel">January</span>
      </div>
      <button id="playBtn" class="btn">▶ Play</button>
    </div>

    <div>
      <div class="small muted">Countries</div>
      <div class="countries" id="countryList"></div>
    </div>

    <div class="card">
      <div class="chart-wrap">
        <canvas id="ndviChart"></canvas>
      </div>
      <button id="predictBtn" class="btn" style="margin-top:6px;">Get AI Prediction</button>
      <div id="aiText" style="font-size:13px; color:#aaa; margin-top:4px;">Select a month on chart first</div>
    </div>
  </div>
</div>

<script>
// ---------------------------
// Data
// ---------------------------
const LOCATIONS = [
  { id: 'japan', label: 'Japan', lat:36.2,lng:138.25,species:'Sakura',peakMonth:3,color:'#ffb6c1' },
  { id: 'alaska', label: 'Alaska', lat:64.2,lng:-149.49,species:'Arctic Flowers',peakMonth:6,color:'#649ac8' },
  { id: 'madagascar', label: 'Madagascar', lat:-18.77,lng:46.87,species:'Baobab',peakMonth:9,color:'#2e7d32' }
];

const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];

// Generate bloom points
let ALL_BLOOMS = [];
LOCATIONS.forEach(loc=>{
  for(let m=0;m<12;m++){
    for(let i=0;i<15;i++){
      const jitterLat = (Math.random()-0.5)*2;
      const jitterLng = (Math.random()-0.5)*2;
      const phase = (m - loc.peakMonth)*Math.PI/6;
      const intensity = Math.max(0, Math.sin(-phase)**2);
      ALL_BLOOMS.push({
        id:`${loc.id}-m${m}-p${i}`,
        lat: loc.lat+jitterLat,
        lng: loc.lng+jitterLng,
        month:m,
        locationId: loc.id,
        label: loc.label,
        species: loc.species,
        intensity,
        color: loc.color,
        __alt: 0.03 + intensity*0.12,
        __rad: 0.25 + intensity*0.6
      });
    }
  }
});

// ---------------------------
// Globe
// ---------------------------
const GlobeEl = document.getElementById('globeViz');
const GlobeInstance = Globe()
  .globeImageUrl(null)
  .backgroundColor('#000')
  .showAtmosphere(false)
  .showGraticules(true)
  .pointAltitude(d=>d.__alt)
  .pointRadius(d=>d.__rad)
  .pointColor(d=>d.color)
  .onPointHover(d=>{
    const t = document.getElementById('tooltip');
    if(d){
      t.style.display='block';
      t.innerHTML = `<b>${d.label}</b><br>${d.species}<br>Peak: ${monthNames[d.month]}<br>Intensity:${d.intensity.toFixed(2)}`;
    } else t.style.display='none';
  });

GlobeInstance(GlobeEl);

// ---------------------------
// Month controls
// ---------------------------
let currentMonth = 0;
let isPlaying = false;
function setMonth(m){
  currentMonth = m;
  document.getElementById('monthLabel').textContent = monthNames[m];
  const monthPoints = ALL_BLOOMS.filter(p=>p.month===m);
  GlobeInstance.pointsData(monthPoints);
}
setMonth(0);

document.getElementById('monthSlider').addEventListener('input', e=>{
  setMonth(parseInt(e.target.value));
});

document.getElementById('playBtn').addEventListener('click', ()=>{
  isPlaying = !isPlaying;
  if(isPlaying){
    document.getElementById('playBtn').textContent='⏸ Pause';
    playHandle = setInterval(()=>{ setMonth((currentMonth+1)%12); document.getElementById('monthSlider').value=currentMonth; }, 1000);
  } else {
    document.getElementById('playBtn').textContent='▶ Play';
    clearInterval(playHandle);
  }
});
let playHandle = null;

// ---------------------------
// Country buttons
// ---------------------------
const countryList = document.getElementById('countryList');
LOCATIONS.forEach(loc=>{
  const btn = document.createElement('div');
  btn.className='country-btn';
  btn.textContent=loc.label;
  btn.addEventListener('click', ()=>{
    setMonth(loc.peakMonth);
    GlobeInstance.pointOfView({lat:loc.lat,lng:loc.lng,altitude:1.6},1200);
  });
  countryList.appendChild(btn);
});

// ---------------------------
// NDVI chart
// ---------------------------
const chartCtx = document.getElementById('ndviChart').getContext('2d');
let ndviChart = new Chart(chartCtx,{
  type:'line',
  data:{
    labels: monthNames,
    datasets:[{
      label:'NDVI',
      data: Array(12).fill(0).map(()=>Math.random()*0.5+0.3),
      borderColor:'#2ca02c',
      backgroundColor:'rgba(44,160,44,0.2)',
      fill:true,
      tension:0.3
    }]
  },
  options:{scales:{y:{min:0,max:1}}}
});

// AI prediction button
document.getElementById('predictBtn').addEventListener('click', ()=>{
  const val = ndviChart.data.datasets[0].data[currentMonth];
  document.getElementById('aiText').textContent = `For ${monthNames[currentMonth]}, NDVI is ${val.toFixed(2)} — simple seasonal estimate.`;
});
</script>
</body>
</html>
