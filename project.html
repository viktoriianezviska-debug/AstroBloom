<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AstroBloom 3D Globe</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700&display=swap" rel="stylesheet">

<!-- Libraries -->
<script src="https://unpkg.com/three/build/three.min.js"></script>
<script src="https://unpkg.com/globe.gl"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
/* GLOBAL STYLES */
html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#000; font-family:'Syne', sans-serif; }
#globeViz { position:absolute; top:0; left:0; width:100vw; height:100vh; z-index:1; }

/* UI PANEL */
#uiPanel {
    position:absolute; top:20px; right:20px; width:420px;
    background:rgba(0,0,0,0.85); color:#fff; padding:20px;
    border-radius:20px; z-index:10; font-size:14px; backdrop-filter: blur(5px);
}
#monthSlider { width:100%; margin-top:5px; }
.chart-container { height:250px; margin-top:10px; }
.btn {
    background:#1f2937; color:#fff; border:none; padding:8px 12px; margin:2px;
    border-radius:8px; cursor:pointer; transition:0.2s;
}
.btn:hover { background:#374151; }
#infoPanel { margin-top:10px; font-size:12px; color:#aaa; }
.loader { border:4px solid #f3f3f3; border-top:4px solid #3498db; border-radius:50%; width:20px; height:20px; animation:spin 1s linear infinite; margin:auto; }
@keyframes spin { 0% {transform:rotate(0deg);} 100% {transform:rotate(360deg);} }
</style>
</head>
<body>

<div id="globeViz"></div>

<div id="uiPanel">
    <h2 style="margin-bottom:10px;">AstroBloom Control Panel</h2>

    <label for="monthSlider">Month: <span id="monthLabel">January</span></label>
    <input type="range" id="monthSlider" min="0" max="11" step="1" value="0">
    <button id="playBtn" class="btn">▶ Play</button>

    <h3 style="margin-top:15px;">Select Country</h3>
    <div id="countryButtons" style="margin-bottom:10px;"></div>

    <div class="chart-container">
        <canvas id="ndviChart"></canvas>
    </div>

    <div id="infoPanel">Hover a bloom point to see species and peak bloom month.</div>
</div>

<script>
// ==========================
// DATA SECTION
// ==========================

// Months
const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];

// Locations
const locations = [
    {label:"Japan", lat:36.2048, lng:138.2529, species:"Sakura", peakMonth:3, color:"#FFB6C1"},
    {label:"Alaska", lat:64.2008, lng:-149.4937, species:"Lupine", peakMonth:6, color:"#649AC8"},
    {label:"Madagascar", lat:-18.7669, lng:46.8691, species:"Baobab", peakMonth:9, color:"#2E7D32"},
    {label:"New Zealand", lat:-40.9006, lng:174.8860, species:"Kōwhai", peakMonth:10, color:"#FFD700"},
    {label:"Fiji", lat:-17.7134, lng:178.0650, species:"Hibiscus", peakMonth:5, color:"#FF4500"}
];

// Bloom points
let bloomData = [];
locations.forEach(loc => {
    for(let m=0; m<12; m++){
        const intensity = Math.max(0, Math.sin((m-loc.peakMonth)*Math.PI/6))**2;
        for(let i=0; i<15; i++){
            bloomData.push({
                lat: loc.lat + (Math.random()-0.5)*5,
                lng: loc.lng + (Math.random()-0.5)*5,
                month: m,
                label: loc.label,
                species: loc.species,
                intensity: intensity,
                color: loc.color
            });
        }
    }
});

// Simulated NDVI data
function generateNDVI(locationName){
    const loc = locations.find(l=>l.label===locationName);
    const dates = [], ndvi=[];
    const base = 0.4 + Math.random()*0.2;
    const season = 0.25;
    for(let i=0;i<60;i++){
        const date = new Date(2018, i, 1);
        dates.push(date);
        let month = date.getMonth();
        if(loc.label==="New Zealand") month=(month+6)%12;
        ndvi.push(Math.max(0, Math.min(1, base+season*Math.sin(month*Math.PI/6)+0.05*(Math.random()-0.5))));
    }
    return {dates, ndvi};
}

let ndviData = {};
locations.forEach(l => ndviData[l.label] = generateNDVI(l.label));

// ==========================
// GLOBE SECTION
// ==========================
const GlobeObj = Globe()
    .globeImageUrl(null)
    .backgroundColor('#000')
    .showGraticules(true)
    .pointAltitude(d => 0.05 + d.intensity*0.15)
    .pointColor(d => d.color)
    .pointRadius(d => 0.3 + d.intensity*0.7)
    .pointsTransitionDuration(500)
    .pointLabel(d => `<b>${d.label}</b><br>${d.species}<br>Peak Month: ${monthNames[d.month]}`)
    (document.getElementById('globeViz'));

GlobeObj.controls().autoRotate = true;
GlobeObj.controls().autoRotateSpeed = 0.3;

// Current month
let currentMonth = 0;
function updateMonth(month){
    currentMonth = month;
    document.getElementById('monthLabel').textContent = monthNames[month];
    const points = bloomData.filter(d => d.month === month);
    GlobeObj.pointsData(points);
}
updateMonth(0);

// Animate bloom pulsing
(function animateBloom(){
    requestAnimationFrame(animateBloom);
    const points = GlobeObj.pointsData();
    if(points){
        points.forEach(p=>{
            const factor = 0.7 + 0.3*Math.sin(Date.now()*0.005 + p.lat);
            p.__alt = 0.05 + p.intensity*0.15*factor;
            p.__rad = 0.3 + p.intensity*0.7*factor;
        });
        GlobeObj.pointsData(points);
    }
})();

// ==========================
// SLIDER & PLAY BUTTON
// ==========================
const slider = document.getElementById('monthSlider');
slider.addEventListener('input', () => updateMonth(parseInt(slider.value)));

let playInterval = null;
let isPlaying = false;
document.getElementById('playBtn').addEventListener('click', ()=>{
    if(!isPlaying){
        isPlaying=true;
        document.getElementById('playBtn').textContent='⏸ Pause';
        playInterval = setInterval(()=>updateMonth((currentMonth+1)%12),1500);
    }else{
        isPlaying=false;
        document.getElementById('playBtn').textContent='▶ Play';
        clearInterval(playInterval);
    }
});

// ==========================
// COUNTRY BUTTONS
// ==========================
const countryContainer = document.getElementById('countryButtons');
locations.forEach(l=>{
    const btn=document.createElement('button');
    btn.textContent = l.label;
    btn.className = 'btn';
    btn.addEventListener('click', ()=>{updateChart(l.label); updateMonth(l.peakMonth);});
    countryContainer.appendChild(btn);
});

// ==========================
// NDVI CHART
// ==========================
let myChart = null;
function updateChart(locationName){
    const data = ndviData[locationName];
    if(!data) return;

    const labels = data.dates.map(d=>d.toLocaleDateString('en-US',{month:'short', year:'numeric'}));
    const historical = data.ndvi;
    const predicted = [];
    const lastVal = historical[historical.length-1];
    for(let i=1;i<=12;i++) predicted.push(Math.min(1, lastVal + 0.01*i));
    const allData = historical.concat(predicted);

    const ctx = document.getElementById('ndviChart').getContext('2d');
    if(myChart) myChart.destroy();

    myChart = new Chart(ctx,{
        type:'line',
        data:{
            labels: labels.concat(labels.slice(0,12)),
            datasets:[
                {label:'Historical NDVI', data: historical, borderColor:'#2ca02c', backgroundColor:'rgba(44,160,44,0.2)', fill:false, tension:0.4},
                {label:'Predicted NDVI', data: allData, borderColor:'#ff7f0e', backgroundColor:'rgba(255,127,14,0.2)', fill:false, borderDash:[5,5], tension:0.4}
            ]
        },
        options:{
            responsive:true, maintainAspectRatio:false,
            plugins:{legend:{labels:{color:'#fff'}}},
            scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}, min:0, max:1}}
        }
    });
}

// Init chart
updateChart('Japan');

</script>

</body>
</html>
