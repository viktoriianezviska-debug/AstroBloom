<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Interactive NDVI Globe & Chart</title>

<!-- Syne font -->
<link href="https://fonts.googleapis.com/css2?family=Syne&display=swap" rel="stylesheet" />

<style>
  body, html {
    margin: 0; padding: 0; height: 100vh; overflow: hidden;
    background: #000;
    color: #ff1493;
    font-family: 'Syne', sans-serif;
    display: flex;
  }
  #globeViz {
    flex: 1;
    position: relative;
  }
  #chartContainer {
    flex: 1;
    padding: 20px;
    background: rgba(255, 20, 147, 0.1);
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  h2 {
    margin: 0 0 10px 0;
    color: #ff69b4;
  }
  #countryName {
    font-weight: 700;
    font-size: 1.5em;
    margin-bottom: 15px;
  }
  #tooltip {
    position: absolute;
    background: rgba(255, 20, 147, 0.85);
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    pointer-events: none;
    font-size: 14px;
    font-weight: 600;
    opacity: 0;
    transition: opacity 0.2s ease;
    z-index: 10;
  }
  canvas {
    background: transparent !important;
    display: block;
  }
</style>

</head>
<body>

<div id="globeViz"></div>

<div id="chartContainer">
  <div id="countryName">Select a country</div>
  <canvas id="ndviChart"></canvas>
</div>

<div id="tooltip"></div>

<!-- Three.js + Globe.gl -->
<script src="https://unpkg.com/three@0.148.0/build/three.min.js"></script>
<script src="https://unpkg.com/three-globe@2.25.2/dist/three-globe.min.js"></script>

<!-- Topojson -->
<script src="https://cdn.jsdelivr.net/npm/topojson@3"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // --- Locations and NDVI data (sample) ---
  const locations = {
    "Japan": { lat: 36.2048, lon: 138.2529 },
    "Alaska": { lat: 64.2008, lon: -149.4937 },
    "Madagascar": { lat: -18.7669, lon: 46.8691 },
    "New Zealand": { lat: -40.9006, lon: 174.8860 },
    "Fiji": { lat: -17.7134, lon: 178.0650 }
  };

  // Generate synthetic NDVI data with predictions for demo
  function generateSampleNDVI(pastMonths = 60, futureMonths = 12, base = 0.5, amplitude = 0.3) {
    const data = [];
    const startDate = new Date(2018, 0, 1);
    for (let i = 0; i < pastMonths + futureMonths; i++) {
      const date = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1);
      let val = base + amplitude * Math.sin((2 * Math.PI * i) / 12) + 0.05 * (Math.random() - 0.5);
      val = Math.min(Math.max(val, 0), 1);
      data.push({ date: date.toISOString().substring(0, 10), ndvi: val });
    }
    return data;
  }

  const ndviData = {
    "Japan": generateSampleNDVI(60, 12, 0.6, 0.3),
    "Alaska": generateSampleNDVI(60, 12, 0.5, 0.2),
    "Madagascar": generateSampleNDVI(60, 12, 0.7, 0.25),
    "New Zealand": generateSampleNDVI(60, 12, 0.55, 0.3),
    "Fiji": generateSampleNDVI(60, 12, 0.6, 0.35)
  };

  // --- Setup Globe ---

  // Create globe
  const Globe = new ThreeGlobe()
    .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
    .showAtmosphere(false)
    .polygonsCapColor(() => 'rgba(255,20,147,0.4)')
    .polygonsSideColor(() => 'rgba(255,20,147,0.1)')
    .polygonsStrokeColor(() => '#ff1493')
    .polygonAltitude(0.06);

  // Setup scene, camera, renderer
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera();
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  camera.position.z = 300;

  const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(window.innerWidth / 2, window.innerHeight);
  renderer.setClearColor(0x000000, 0); // transparent background

  document.getElementById('globeViz').appendChild(renderer.domElement);
  scene.add(Globe);
  scene.add(new THREE.AmbientLight(0xffffff, 0.9));
  scene.add(new THREE.DirectionalLight(0xffffff, 0.4));

  // Load and add countries polygons
  fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
    .then(res => res.json())
    .then(worldData => {
      const countries = topojson.feature(worldData, worldData.objects.countries).features;
      Globe.polygonsData(countries);
    });

  // Handle resizing
  window.addEventListener('resize', () => {
    renderer.setSize(window.innerWidth / 2, window.innerHeight);
    camera.aspect = (window.innerWidth / 2) / window.innerHeight;
    camera.updateProjectionMatrix();
  });

  // Animate globe rotation
  function animate() {
    Globe.rotation.y += 0.0012;
    renderer.render(scene, camera);
    requestAnimationFrame(animate);
  }
  animate();

  // --- Tooltip setup ---
  const tooltip = document.getElementById('tooltip');

  const raycaster = new THREE.Raycaster();
  const mouse = new THREE.Vector2();

  renderer.domElement.addEventListener('mousemove', e => {
    const rect = renderer.domElement.getBoundingClientRect();
    mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
    mouse.y = - ((e.clientY - rect.top) / rect.height) * 2 + 1;

    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObjects(Globe.polygonsMeshes);

    if (intersects.length > 0) {
      const props = intersects[0].object.userData.feature.properties;
      tooltip.style.opacity = 1;
      tooltip.style.left = e.clientX + 10 + 'px';
      tooltip.style.top = e.clientY + 10 + 'px';
      tooltip.textContent = props.ADMIN;
    } else {
      tooltip.style.opacity = 0;
    }
  });

  // --- Chart setup ---
  const ctx = document.getElementById('ndviChart').getContext('2d');
  const countryNameEl = document.getElementById('countryName');

  const ndviChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'NDVI',
        data: [],
        borderColor: '#ff1493',
        backgroundColor: 'rgba(255,20,147,0.3)',
        pointRadius: 3,
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 500 },
      scales: {
        x: {
          type: 'time',
          time: { unit: 'month', tooltipFormat: 'MMM YYYY' },
          ticks: { color: '#ff1493' },
          grid: { color: 'rgba(255,20,147,0.1)' }
        },
        y: {
          min: 0,
          max: 1,
          ticks: { color: '#ff1493' },
          grid: { color: 'rgba(255,20,147,0.1)' },
          title: { display: true, text: 'NDVI (Vegetation Index)', color: '#ff1493' }
        }
      },
      plugins: {
        legend: { labels: { color: '#ff1493' } }
      }
    }
  });

  // --- Country mapping for NDVI locations ---
  const countryMapping = {
    "Japan": "Japan",
    "United States of America": "Alaska",
    "Madagascar": "Madagascar",
    "New Zealand": "New Zealand",
    "Fiji": "Fiji"
  };

  // --- Functions ---

  // Smoothly fly globe to location
  function flyToLocation(lat, lon) {
    const phi = (90 - lat) * (Math.PI / 180);
    const theta = (lon + 180) * (Math.PI / 180);

    const targetY = theta - Math.PI;
    const targetX = phi - Math.PI / 2;

    let frame = 0;
    const totalFrames = 120;

    const startX = Globe.rotation.x;
    const startY = Globe.rotation.y;

    function animateFly() {
      frame++;
      const lerpX = startX + (targetX - startX) * (frame / totalFrames);
      const lerpY = startY + (targetY - startY) * (frame / totalFrames);
      Globe.rotation.x = lerpX;
      Globe.rotation.y = lerpY;
      if (frame < totalFrames) {
        requestAnimationFrame(animateFly);
      }
    }
    animateFly();
  }

  // Update chart with NDVI data for given location name
  function updateChart(locationName) {
    const data = ndviData[locationName];
    if (!data) return;

    countryNameEl.textContent = locationName;

    ndviChart.data.labels = data.map(d => new Date(d.date));
    ndviChart.data.datasets[0].data = data.map(d => d.ndvi);

    ndviChart.update();
  }

  // --- Globe click interaction ---
  renderer.domElement.addEventListener('click', e => {
    const rect = renderer.domElement.getBoundingClientRect();
    mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
    mouse.y = - ((e.clientY - rect.top) / rect.height) * 2 + 1;

    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObjects(Globe.polygonsMeshes);

    if (intersects.length > 0) {
      const countryProps = intersects[0].object.userData.feature.properties;
      const countryName = countryProps.ADMIN;

      if (countryMapping[countryName]) {
        const locName = countryMapping[countryName];
        const { lat, lon } = locations[locName];
        flyToLocation(lat, lon);
        updateChart(locName);
      } else {
        countryNameEl.textContent = `No NDVI data for ${countryName}`;
      }
    }
  });

</script>

</body>
</html>
