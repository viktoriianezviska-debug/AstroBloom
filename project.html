<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>NASA Global NDVI Project</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Syne font -->
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700&display=swap" rel="stylesheet">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Three.js + Globe.gl -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
  <script src="https://unpkg.com/globe.gl"></script>
  <style>
    body { font-family:'Syne',sans-serif; background:#09010C; color:#ffd1e6; }
    canvas { background:transparent!important; }
    #globeViz { width:100%; height:100%; min-height:420px; }
    .glass-card { background:rgba(48,6,48,0.6); backdrop-filter:blur(6px);
      border-radius:1.2rem; border:1.5px solid #db288e44;
      box-shadow:0 4px 24px -6px #db288e66; }
    .chart-title { border-left:4px solid #db288e; padding-left:.6em; font-weight:700; margin-bottom:.6em; }
    .country-btn { background:#270022; color:#ffd1e6; border:1.5px solid #db288e44; 
      border-radius:9999px; padding:.5em 1.2em; margin:.3em; font-weight:600; }
    .country-btn.active, .country-btn:hover { background:#db288e; color:white; }
    .ai-btn { background:#fff; color:#db288e; border-radius:9999px; padding:.5em 1.2em;
      font-weight:700; transition:.2s; }
    .ai-btn:hover { background:#db288e; color:white; }
  </style>
</head>
<body class="h-screen flex flex-col">

<!-- Layout -->
<div class="flex flex-1 flex-col md:flex-row">

  <!-- Globe Column -->
  <div class="flex-1 relative flex items-center justify-center p-4">
    <div id="globeViz"></div>
    <div id="globeControls" class="absolute top-5 left-5 glass-card px-4 py-3 text-sm">
      <label class="mr-3"><input type="checkbox" id="ndvi-layer" checked> NDVI</label>
      <label><input type="checkbox" id="pollinators-layer" checked> Pollinators</label>
    </div>
  </div>

  <!-- Charts Column -->
  <div class="flex-[1.3] flex flex-col gap-6 p-6 overflow-y-auto">

    <!-- Upload + Country -->
    <div class="glass-card p-5">
      <h2 class="chart-title">NDVI Data Upload</h2>
      <label class="block mb-3">
        <span class="mr-2">Upload MODIS HDF/CSV:</span>
        <input type="file" id="hdf-file-input" accept=".hdf,.csv" class="text-pink-200">
      </label>
      <span id="upload-status-message" class="text-pink-300 text-sm"></span>
      <div id="country-buttons-container" class="mt-4 flex flex-wrap"></div>
    </div>

    <!-- NDVI Chart -->
    <div class="glass-card p-5">
      <div class="flex justify-between items-center mb-3">
        <h2 class="chart-title m-0">NDVI Seasonality & Prediction</h2>
        <button id="ai-predict-btn" class="ai-btn">AI Prediction</button>
      </div>
      <div class="h-64"><canvas id="ndviChart"></canvas></div>
      <div id="ai-response-container" class="mt-3 text-pink-200 text-sm"></div>
    </div>

    <!-- Data Panel -->
    <div class="glass-card p-5">
      <h2 class="chart-title">Bloom & Pollinator Insights</h2>
      <div id="dataPanel"></div>
    </div>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

/* -------- Data -------- */
const locations = {
  "Japan": { lat:36.2, lng:138.2 },
  "Alaska": { lat:64.2, lng:-149.5 },
  "Madagascar": { lat:-18.9, lng:47.5 },
  "New Zealand": { lat:-40.9, lng:174.9 },
  "Fiji": { lat:-17.7, lng:178.1 }
};
const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

// Bloom + Pollinators (simplified)
const bloomData = [
  {lat:36.2,lng:138.2,month:3,color:"#db288e",label:"Japan",species:"Cherry Blossom",note:"Peak in spring"},
  {lat:64.2,lng:-149.5,month:6,color:"#a2cff1",label:"Alaska",species:"Arctic Lupine",note:"Short season"},
];
const pollinators = [
  {lat:36.2,lng:138.5,icon:"ü¶ã",label:"Butterfly",region:"Japan",month:[3,4,5]},
  {lat:64.3,lng:-149.3,icon:"üêù",label:"Bee",region:"Alaska",month:[6,7]},
];

// Generate NDVI
function genNDVI(loc, start="2019-01-01", months=48){
  let base=0.5,f=0.2;
  if(loc==="Japan") {base=0.45;f=0.25;}
  if(loc==="Alaska"){base=0.2;f=0.6;}
  const startDate=new Date(start);
  let dates=[],vals=[];
  for(let i=0;i<months;i++){
    let d=new Date(startDate.getFullYear(), startDate.getMonth()+i,1);
    let m=d.getMonth();
    vals.push(Math.max(0,Math.min(1, base+f*Math.sin(m*Math.PI/6)+0.05*(Math.random()-0.5))));
    dates.push(d);
  }
  return {dates,ndvi:vals};
}
const ndviDataAll={};
for(let loc in locations) ndviDataAll[loc]=genNDVI(loc);
let customNdvi={}, currentLocation="Japan", currentMonth=(new Date()).getMonth();

/* -------- Globe -------- */
let globeInstance;
function initGlobe(){
  document.getElementById('globeViz').innerHTML="";
  globeInstance=Globe()
    .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
    .backgroundColor('rgba(0,0,0,0)')
    .pointLat('lat').pointLng('lng').pointColor(d=>d.color)
    .pointAltitude(0.05).pointRadius(0.45)
    .pointLabel(d=>`<b>${d.label}</b><br>${d.species}<br><span class="text-xs">${d.note}</span>`)
    (document.getElementById('globeViz'));
  globeInstance.controls().autoRotate=true;
  globeInstance.controls().autoRotateSpeed=0.25;
  updateGlobe(currentMonth);
}
function updateGlobe(month){
  globeInstance.pointsData(
    document.getElementById("ndvi-layer").checked? bloomData.filter(d=>d.month===month):[]
  );
}

/* -------- Country Buttons -------- */
function makeCountryBtns(){
  const c=document.getElementById("country-buttons-container"); c.innerHTML="";
  for(let loc in locations){
    const b=document.createElement("button");
    b.className="country-btn"; b.textContent=loc;
    b.onclick=()=>setCountry(loc);
    c.appendChild(b);
  }
}
function setCountry(loc){
  document.querySelectorAll(".country-btn").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".country-btn").forEach(b=>{if(b.textContent===loc)b.classList.add("active");});
  currentLocation=loc; updateChart(loc);
}

/* -------- Chart -------- */
let myChart;
function updateChart(loc){
  const {dates,ndvi}=customNdvi[loc]||ndviDataAll[loc];
  const labels=dates.map(d=>monthNames[d.getMonth()]+" '"+d.getFullYear().toString().slice(-2));
  if(myChart) myChart.destroy();
  myChart=new Chart(document.getElementById("ndviChart"),{
    type:'line', data:{labels,datasets:[
      {label:"NDVI",data:ndvi,borderColor:"#ffd1e6",tension:0.3}
    ]},
    options:{responsive:true,interaction:{mode:"nearest"},
      onClick:(e)=>{
        const pts=myChart.getElementsAtEventForMode(e,"nearest",{intersect:true},true);
        if(pts.length){let idx=pts[0].index; currentMonth=dates[idx].getMonth(); updateGlobe(currentMonth); updatePanel(loc,currentMonth);}
      },
      plugins:{legend:{labels:{color:"#ffd1e6"}}},
      scales:{x:{ticks:{color:"#db288e"}},y:{min:0,max:1,ticks:{color:"#db288e"}}}
    }
  });
  updatePanel(loc,currentMonth);
}

/* -------- Data Panel -------- */
function updatePanel(loc,month){
  const {dates,ndvi}=customNdvi[loc]||ndviDataAll[loc];
  const vals=ndvi.filter((_,i)=>dates[i].getMonth()===month);
  const avg=vals.length?(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2):"N/A";
  const blooms=bloomData.filter(b=>b.label===loc&&b.month===month);
  const pollis=pollinators.filter(p=>p.region===loc&&p.month.includes(month));
  document.getElementById("dataPanel").innerHTML=`
    <b class="text-pink-400">${loc} (${monthNames[month]})</b><br>
    Avg NDVI: ${avg}<br>
    Blooms: ${blooms.length?blooms[0].species:"None"}<br>
    Pollinators: ${pollis.length?pollis.map(p=>p.icon+" "+p.label).join(", "):"None"}
  `;
}

/* -------- AI Prediction -------- */
document.getElementById("ai-predict-btn").onclick=()=>{
  const {dates,ndvi}=customNdvi[currentLocation]||ndviDataAll[currentLocation];
  const vals=ndvi.filter((_,i)=>dates[i].getMonth()===currentMonth);
  const avg=vals.length?(vals.reduce((a,b)=>a+b,0)/vals.length):null;
  let msg="No data available.";
  if(avg!==null){
    if(avg>0.7) msg="High vegetation activity üå± ‚Äî peak season.";
    else if(avg>0.4) msg="Moderate activity ‚Äî crops active.";
    else msg="Low NDVI ‚Äî dormant or dry season.";
  }
  document.getElementById("ai-response-container").innerHTML=`<b>AI Prediction:</b> ${avg?avg.toFixed(2):"N/A"} ‚Äî ${msg}`;
};

/* -------- Upload -------- */
document.getElementById("hdf-file-input").addEventListener("change", e=>{
  const file=e.target.files[0]; if(!file) return;
  const msg=document.getElementById("upload-status-message"); msg.textContent="Processing...";
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const text=ev.target.result.split(/\r?\n/).filter(x=>x.trim());
      let d=[],v=[];
      text.forEach(row=>{
        const [date,val]=row.split(/[,\s]+/);
        if(date&&val){d.push(new Date(date)); v.push(parseFloat(val));}
      });
      customNdvi[currentLocation]={dates:d,ndvi:v};
      updateChart(currentLocation);
      msg.textContent="Upload successful!";
    }catch{msg.textContent="Error parsing file.";}
  };
  r.readAsText(file);
});

/* -------- Init -------- */
makeCountryBtns(); setCountry(currentLocation); initGlobe();

});
</script>
</body>
</html>
