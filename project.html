<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AstroBloom Project</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://unpkg.com/three"></script>
<script src="https://unpkg.com/globe.gl"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  /* General resets */
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100%; font-family: 'Syne', sans-serif; background: #000; color: #fff; }
  header { position: fixed; top:0; width:100%; background:black; color:white; display:flex; justify-content:center; padding:12px 20px; z-index:1000; }
  header nav a { color:white; text-decoration:none; margin:0 15px; font-weight:bold; font-size:18px; transition:color 0.3s; }
  header nav a:hover { color:#ad1c69; }
  main { padding-top:80px; }
  
  /* Globe */
  #globeViz { width:100%; height:70vh; }
  #sliderContainer { position:absolute; bottom:20px; width:100%; text-align:center; font-size:1.2em; color:white; }
  input[type="range"] { width:60%; }
  #playBtn { margin-top:10px; padding:8px 16px; font-size:1em; cursor:pointer; border-radius:8px; border:none; }

  /* Chart Section */
  .chart-section { width: 100%; max-width:1200px; margin:40px auto; padding:20px; background:#0d0d0d; border-radius:16px; }
  #ndviChart { width:100%; height:300px; }
  #chart-status { color:#888; }

  /* Map Section */
  #map { width:100%; height:500px; border-radius:16px; margin-top:40px; }

  /* AI Prediction */
  #ai-response-container { background:#111; color:#ccc; padding:16px; border-radius:12px; min-height:60px; margin-top:16px; }

  .strip { background:black; color:white; font-size:18px; line-height:1.6; padding:20px 40px; text-align:left; margin-top:40px; }

  button { cursor:pointer; }
</style>
</head>
<body>

<header>
  <nav>
    <a href="index.html">Home</a> |
    <a href="project.html">Project</a> |
    <a href="about.html">About</a>
  </nav>
</header>

<main>
  <!-- Globe -->
  <div id="globeViz"></div>
  <div id="sliderContainer">
    <span id="monthLabel">January</span><br>
    <input type="range" id="monthSlider" min="0" max="11" step="1" value="0"><br>
    <button id="playBtn">▶ Play</button>
  </div>

  <!-- Chart -->
  <div class="chart-section">
    <canvas id="ndviChart"></canvas>
    <div id="chart-status">Loading chart...</div>

    <div id="ai-prediction-section">
      <h3>AI Prediction</h3>
      <div id="ai-response-container">AI responses will appear here.</div>
      <div id="selected-month-info" style="display:none; margin-top:8px;">
        <span>Selected Month: </span><span id="selected-month-text" style="color:#4fa1ff;"></span>
        <button id="get-prediction-button" style="margin-left:10px; padding:4px 8px;">Get AI Prediction</button>
      </div>
    </div>

    <div style="margin-top:20px;">
      <label for="hdf-file-input">Upload a MODIS HDF file:</label>
      <input type="file" id="hdf-file-input" accept=".hdf">
      <p id="upload-status-message"></p>
    </div>
  </div>

  <!-- Map -->
  <div id="map"></div>

</main>

<div class="strip">Connecting science with practical applications and insights.</div>

<script>
/* ---------------- GLOBE ---------------- */
const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const bloomData = [];

function addBloom(lat,lng,month,info,count=10,spread=3){
  for(let i=0;i<count;i++){
    bloomData.push({
      lat:lat+(Math.random()-0.5)*spread,
      lng:lng+(Math.random()-0.5)*spread,
      month,
      ...info
    });
  }
}

// Japan
["#e8eb49ff","#f5a2acff","#f484d4ff","#e647b9ff","#ab8aecff","#d56de3ff","#e898ecff","#f399f0ff","#de4242ff","#c27d37ff","#e16473ff","#f1ebb2ff"]
.forEach((color,i)=>{addBloom(36.2,138.2,i,{color,label:"Japan",species:"Cherry Blossom - Sakura",note:"Cultural symbol, peak bloom in spring; critical for pollinators."},15,5)});

// Alaska
["#83b1ddff","#649ac8ff","#a2d7ecff","#6a5acd","#8f2da0ff","#d25db9ff","#cad239ff","#d9eaa5ff","#94dee1ff","#5cabcaff","#34879eff","#4b6cb1ff"]
.forEach((color,i)=>{addBloom(64.2,-149.5,i,{color,label:"Alaska",species:"Lupine and Arctic Poppy",note:"Short growing season; blooms support insects."},12,6)});

// Madagascar
["#2e7d32","#4b9d4fff","#6bc56fff","#e1a2d6ff","#8be0ddff","#98d6e7ff","#8ae5e5ff","#9adbedff","#c71585","#edb232ff","#e2b330ff","#b288d1ff"]
.forEach((color,i)=>{addBloom(-18.9,47.5,i,{color,label:"Madagascar",species:"Baobab and Traveler's Palm",note:"Unique flora; blooms influence lemur feeding and pollination."},15,5)});

// New Zealand
["#ff1493","#ff1493","#ff8c00","#b22222","#b22222","#778899","#87ceeb","#ffb6c1","#ffff00","#e3e54eff","#cb84c9ff","#b52212ff"]
.forEach((color,i)=>{addBloom(-40.9,174.9,i,{color,label:"New Zealand Bloom",species:"Kōwhai and Pohutukawa",note:"Seasonal shifts vital for native birds like tui and bellbirds."},15,5)});

// Fiji
["#ebe41fff","#efa3eeff","#e28ee8ff","#ef6caeff","#ea9cd4ff","#da48c2ff","#ffffff","#ff4500","#ea8ecbff","#edaa92ff","#eea58bff","#e69a87ff"]
.forEach((color,i)=>{addBloom(-17.7,178.1,i,{color,label:"Fiji",species:"Hibiscus and Breadfruit",note:"Blooms tied to rainfall cycles; important for pollinators and agriculture."},15,5)});

const GlobeObj = Globe()
  .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
  .pointAltitude(d=>0.02+0.02*Math.sin(Date.now()*0.005+d.lat))
  .pointRadius(0.4)
  .pointColor(d=>d.color)
  .pointLabel(d=>`<b>${d.label}</b><br><i>${d.species}</i><br>${d.note}`);

GlobeObj(document.getElementById('globeViz'));
GlobeObj.controls().autoRotate = true;
GlobeObj.controls().autoRotateSpeed = 0.2;

const slider = document.getElementById("monthSlider");
const label = document.getElementById("monthLabel");
function updateGlobe(monthIndex){
  label.textContent = monthNames[monthIndex];
  const filtered = bloomData.filter(d=>d.month===monthIndex);
  GlobeObj.pointsData(filtered);
}
updateGlobe(0);
slider.addEventListener("input", e=>updateGlobe(parseInt(e.target.value)));
(function animate(){GlobeObj.pointAltitude(d=>0.02+0.02*Math.sin(Date.now()*0.005+d.lat));requestAnimationFrame(animate)})();

let isPlaying=false; let playInterval;
document.getElementById("playBtn").addEventListener("click", ()=>{
  if(!isPlaying){isPlaying=true; this.textContent="⏸ Pause"; playInterval=setInterval(()=>{
    let nextMonth=(parseInt(slider.value)+1)%12; slider.value=nextMonth; updateGlobe(nextMonth);
  },1000);} else {isPlaying=false; this.textContent="▶ Play"; clearInterval(playInterval);}
});

/* ---------------- CHART & MAP ---------------- */
const locations={
  "Japan":{"lat":36.2048,"lon":138.2529},
  "Alaska":{"lat":64.2008,"lon":-149.4937},
  "Madagascar":{"lat":-18.7669,"lon":46.8691},
  "New Zealand":{"lat":-40.9006,"lon":174.8860},
  "Fiji":{"lat":-17.7134,"lon":178.0650}
};

let currentLocation="Japan"; let myChart; let selectedDataPointIndex=null; let fetchedNDVIData={};

function generateNDVIDataForLocation(locationName,startDate,numMonths){
  const dates=[], ndvi=[]; const start=new Date(startDate);
  let seasonalFactor, baseValue;
  switch(locationName){
    case"Japan": baseValue=0.45; seasonalFactor=0.25; break;
    case"Alaska": baseValue=0.2; seasonalFactor=0.6; break;
    case"Madagascar": baseValue=0.7; seasonalFactor=0.08; break;
    case"New Zealand": baseValue=0.5; seasonalFactor=0.2; break;
    case"Fiji": baseValue=0.8; seasonalFactor=0.05; break;
    default: baseValue=0.5; seasonalFactor=0.2;
  }
  for(let i=0;i<numMonths;i++){
    const date=new Date(start.getFullYear(), start.getMonth()+i,1);
    dates.push(date);
    let month=date.getMonth();
    if(locationName==="New Zealand") month=(month+6)%12;
    const value=baseValue+seasonalFactor*Math.sin(month*(Math.PI/6))+0.03*(Math.random()-0.5);
    ndvi.push(Math.max(0,Math.min(1,value)));
  }
  return {dates, ndvi};
}

async function fetchDataAndLoad(){
  const ndviData={}; const numMonths=60;
  for(const loc in locations){ ndviData[loc]=generateNDVIDataForLocation(loc,'2018-01-01',numMonths);}
  return ndviData;
}

function updateChart(locationName){
  currentLocation=locationName;
  const chartData=fetchedNDVIData[locationName]; if(!chartData) return;
  document.getElementById('ndviChart').classList.remove('hidden'); document.getElementById('chart-status').style.display='none';
  const monthlyAverages=new Array(12).fill(0), monthlyCounts=new Array(12).fill(0);
  chartData.dates.forEach((date,i)=>{ const month=date.getMonth(); monthlyAverages[month]+=chartData.ndvi[i]; monthlyCounts[month]++; });
  const seasonalPattern=monthlyAverages.map((sum,month)=>sum/monthlyCounts[month]);
  const xMonths=chartData.dates.map((_,i)=>i); let sumX=0,sumY=0,sumXY=0,sumX2=0; const n=xMonths.length;
  for(let i=0;i<n;i++){sumX+=xMonths[i]; sumY+=chartData.ndvi[i]; sumXY+=xMonths[i]*chartData.ndvi[i]; sumX2+=xMonths[i]*xMonths[i];}
  const m=(n*sumXY-sumX*sumY)/(n*sumX2-sumX*sumX);
  const futureDates=[], predictedNDVI=[]; const lastMonth=chartData.dates[chartData.dates.length-1];
  for(let i=1;i<=12;i++){ const futureDate=new Date(lastMonth.getFullYear(), lastMonth.getMonth()+i,1); const futureMonthIndex=futureDate.getMonth(); const futureMonthTotalIndex=chartData.dates.length+i-1; const prediction=seasonalPattern[futureMonthIndex]+(m*futureMonthTotalIndex); predictedNDVI.push(Math.max(0,Math.min(1,prediction))); futureDates.push(futureDate);}
  const allDates=chartData.dates.concat(futureDates); const allNDVI=chartData.ndvi.concat(predictedNDVI); const lastHistoricalIndex=chartData.dates.length-1;
  const ctx=document.getElementById('ndviChart').getContext('2d');
  if(myChart) myChart.destroy();
  myChart=new Chart(ctx,{
    type:'line',
    data:{labels:allDates.map(d=>d.toLocaleString('default',{month:'short',year:'numeric'})),
      datasets:[
        {label:'Historical NDVI', data:chartData.ndvi, borderColor:'#2ca02c', backgroundColor:'rgba(44,160,44,0.2)', pointBackgroundColor:'#2ca02c', borderWidth:2, pointRadius:3, fill:false, tension:0.4},
        {label:'Predicted NDVI', data:allNDVI, borderColor:'#ff7f0e', backgroundColor:'rgba(255,127,14,0.2)', pointBackgroundColor:'#ff7f0e', borderWidth:2, pointRadius:3, fill:false, borderDash:[5,5], tension:0.4, pointStyle:(context)=>{const index=context.dataIndex; return index<=lastHistoricalIndex?'circle':'star';}}
      ]},
    options:{responsive:true, maintainAspectRatio:false, scales:{x:{ticks:{color:'#9ca3af'}, grid:{color:'rgba(156,163,175,0.1)'}}, y:{min:0,max:1,ticks:{color:'#9ca3af'}, grid:{color:'rgba(156,163,175,0.1)'}}}, plugins:{legend:{labels:{color:'#e5e7eb'}}, tooltip:{backgroundColor:'rgba(31,41,55,0.8)',titleColor:'#e5e7eb',bodyColor:'#9ca3af'}}, onClick:handleChartClick}});
  const infoPanel=document.getElementById('data-visualization-info'); if(infoPanel) infoPanel.innerHTML=`<h3>${locationName}</h3><p>Click a data point to get an AI prediction.</p>`;
  document.getElementById('selected-month-info').style.display='none';
}

function handleChartClick(event){
  const points=myChart.getElementsAtEventForMode(event,'nearest',{intersect:true},true);
  if(points.length){ const firstPoint=points[0]; const label=myChart.data.labels[firstPoint.index]; selectedDataPointIndex=firstPoint.index;
    document.getElementById('selected-month-text').textContent=label;
    document.getElementById('selected-month-info').style.display='inline-block';
  }
}

function getPredictionForSelectedMonth(){
  if(selectedDataPointIndex===null){document.getElementById('ai-response-container').textContent="Please select a month first."; return;}
  const selectedMonth=myChart.data.labels[selectedDataPointIndex]; const selectedValue=myChart.data.datasets[0].data[selectedDataPointIndex]; const predictedValue=myChart.data.datasets[1].data[selectedDataPointIndex];
  const aiResponseContainer=document.getElementById('ai-response-container'); aiResponseContainer.textContent='Thinking...';
  setTimeout(()=>{aiResponseContainer.textContent=`For ${currentLocation}, the predicted NDVI for ${selectedMonth} is approximately ${predictedValue.toFixed(2)}.`;},1500);
}

function initMap(){
  const map=L.map('map').setView([20,0],2);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{subdomains:'abcd',maxZoom:19}).addTo(map);
  for(const loc in locations){const c=locations[loc]; const marker=L.marker([c.lat,c.lon]).addTo(map); marker.bindPopup(loc); marker.on('click',()=>updateChart(loc));}
}

window.onload=async()=>{
  fetchedNDVIData=await fetchDataAndLoad();
  updateChart('Japan');
  initMap();
  document.getElementById('get-prediction-button').addEventListener('click', getPredictionForSelectedMonth);
  document.getElementById('hdf-file-input').addEventListener('change', (event)=>{
    if(event.target.files.length>0){ const msg=document.getElementById('upload-status-message'); msg.textContent='Processing...'; setTimeout(()=>{msg.textContent='File uploaded successfully.'; updateChart(currentLocation);},1500);}
  });
};
</script>

</body>
</html>
