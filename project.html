<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AstroBloom Interactive</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIINfR7xP64jsImS44GdJqLsy7S+A8S53kU=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-200l2hLgL2N4m9D5s0qf0B8Z5D3k2p2s=" crossorigin=""></script>
    <script src="https://unpkg.com/three"></script>
    <script src="https://unpkg.com/globe.gl"></script>

    <style>
        body { 
            margin: 0; 
            background: black; 
            font-family: 'Syne', sans-serif; 
            overflow: hidden;
            color: #e5e7eb;
        }
        #globeViz { 
            width: 100%; 
            height: 100vh; 
        }
        #sliderContainer {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 1.2em;
        }
        .globe-controls {
            position: relative;
        }
        input[type="range"] { 
            width: 80%; 
            -webkit-appearance: none;
            background: #ad1c69;
            height: 8px;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #ffffff;
            border: 2px solid #ad1c69;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #ffffff;
            border: 2px solid #ad1c69;
            border-radius: 50%;
            cursor: pointer;
        }
        .chart-card {
            background-color: #0d0d0d;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1.5rem;
        }
        #map {
            height: 500px;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ad1c69;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Layout */
        @media (max-width: 1024px) {
            .app-container {
                flex-direction: column;
                overflow-y: auto;
            }
            #globeViz {
                height: 50vh;
            }
            .content-container {
                overflow-y: visible;
                padding-bottom: 2rem;
            }
        }
    </style>
</head>
<body class="bg-black text-white">

    <div class="app-container flex flex-col lg:flex-row h-screen w-screen overflow-hidden">
        
        <!-- Interactive Globe Section -->
        <div class="lg:w-1/2 globe-controls flex-shrink-0">
            <div id="globeViz"></div>
            <div id="sliderContainer">
                <span id="monthLabel">January</span><br>
                <input type="range" id="monthSlider" min="0" max="11" step="1" value="0"><br>
                <button id="playBtn" class="mt-4 px-6 py-2 rounded-full border-2 border-transparent text-white font-bold bg-[#ad1c69] hover:bg-[#85154f] transition-colors duration-300">
                    ▶ Play
                </button>
            </div>
        </div>

        <!-- Data Visualization Section -->
        <div class="lg:w-1/2 overflow-y-auto p-8 lg:p-12 space-y-8 content-container flex-grow">
            <h1 class="text-4xl font-bold text-white/90 mb-4">AstroBloom: The Pulse of Life</h1>
            <main class="grid grid-cols-1 gap-8">
                <div class="p-6 bg-black rounded-2xl shadow-xl space-y-6">
                    <h2 class="text-2xl font-bold text-white/90">Data Visualisation</h2>
                    <div id="data-visualization-info" class="text-gray-400">
                        <p>Click a marker on the map or a button below to see its NDVI trend and prediction.</p>
                    </div>
                    
                    <div class="chart-card">
                        <h3 class="text-lg font-semibold text-white/90 mb-2">NDVI Trend & Prediction</h3>
                        <div id="chart-container-wrapper" class="chart-container flex justify-center items-center">
                            <canvas id="ndviChart" class="hidden"></canvas>
                            <div id="chart-status" class="text-gray-400">Loading chart...</div>
                        </div>
                    </div>

                    <div id="ai-prediction-section" class="pt-6">
                        <h3 class="text-2xl font-bold text-white/90 mb-2">AI Prediction</h3>
                        <div id="ai-response-container" class="bg-black text-gray-300 p-4 rounded-lg shadow-inner min-h-[5rem]">
                            AI responses will appear here. Click a data point on the chart and then click "Get AI Prediction" for more info.
                        </div>
                        <div id="selected-month-info" class="mt-4 hidden">
                            <span class="text-white font-medium">Selected Month: </span><span id="selected-month-text" class="text-[#ad1c69]"></span>
                            <button id="get-prediction-button" class="ml-4 bg-[#ad1c69] text-white py-1 px-3 rounded-full hover:bg-[#85154f]">Get AI Prediction</button>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-xl font-semibold text-white/90 mb-4">Select a Country</h3>
                        <div id="country-buttons-container" class="grid grid-cols-3 md:grid-cols-3 gap-3">
                            </div>
                    </div>
                    
                    <div class="pt-6">
                        <h3 class="text-2xl font-bold text-white/90 mb-2">Upload Data</h3>
                        <div class="flex flex-col space-y-2">
                            <label for="hdf-file-input" class="block text-gray-400 font-medium">Upload a MODIS HDF file:</label>
                            <input type="file" id="hdf-file-input" accept=".hdf" class="block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-[#ad1c69] file:text-white
                                hover:file:bg-[#85154f]
                            ">
                            <p id="upload-status-message" class="text-sm text-gray-500 mt-2"></p>
                        </div>
                    </div>
                </div>

                <div>
                    <div id="map" class="w-full"></div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        const bloomData = [];

        function addBloom(lat, lng, month, info, count = 10, spread = 3) {
            for (let i = 0; i < count; i++) {
                bloomData.push({
                    lat: lat + (Math.random() - 0.5) * spread,
                    lng: lng + (Math.random() - 0.5) * spread,
                    month,
                    ...info
                });
            }
        }

        ["#e8eb49ff","#f5a2acff","#f484d4ff","#e647b9ff","#ab8aecff","#d56de3ff","#e898ecff","#f399f0ff","#de4242ff","#c27d37ff","#e16473ff","#f1ebb2ff"].forEach((color, i) => {
            addBloom(36.2, 138.2, i, {
                color,
                label: "Japan",
                species: "Cherry Blossom - Sakura",
                note: "Cultural symbol, peak bloom in spring; critical for pollinators."
            }, 15, 5);
        });

        ["#83b1ddff","#649ac8ff","#a2d7ecff","#6a5acd","#8f2da0ff","#d25db9ff","#cad239ff","#d9eaa5ff","#94dee1ff","#5cabcaff","#34879eff","#4b6cb1ff"].forEach((color, i) => {
            addBloom(64.2, -149.5, i, {
                color,
                label: "Alaska",
                species: "Lupine and Arctic Poppy",
                note: "Short growing season; blooms support insects."
            }, 12, 6);
        });

        ["#2e7d32","#4b9d4fff","#6bc56fff","#e1a2d6ff","#8be0ddff","#98d6e7ff","#8ae5e5ff","#9adbedff","#c71585","#edb232ff","#e2b330ff","#b288d1ff"].forEach((color, i) => {
            addBloom(-18.9, 47.5, i, {
                color,
                label: "Madagascar",
                species: "Baobab and Traveler's Palm",
                note: "Unique flora; blooms influence lemur feeding and pollination."
            }, 15, 5);
        });

        ["#ff1493","#ff1493","#ff8c00","#b22222","#b22222","#778899","#87ceeb","#ffb6c1","#ffff00","#e3e54eff","#cb84c9ff","#b52212ff"].forEach((color, i) => {
            addBloom(-40.9, 174.9, i, {
                color,
                label: "New Zealand Bloom",
                species: "Kōwhai and Pohutukawa",
                note: "Seasonal shifts vital for native birds like tui and bellbirds."
            }, 15, 5);
        });

        ["#ebe41fff","#efa3eeff","#e28ee8ff","#ef6caeff","#ea9cd4ff","#da48c2ff","#ffffff","#ff4500","#ea8ecbff","#edaa92ff","#eea58bff","#e69a87ff"].forEach((color, i) => {
            addBloom(-17.7, 178.1, i, {
                color,
                label: "Fiji",
                species: "Hibiscus and Breadfruit",
                note: "Blooms tied to rainfall cycles; important for pollinators and agriculture."
            }, 15, 5);
        });

        const GlobeObj = Globe()
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
            .pointAltitude(d => 0.02 + 0.02 * Math.sin(Date.now() * 0.005 + d.lat))
            .pointRadius(0.4)
            .pointColor(d => d.color)
            .pointLabel(d => `
                <b>${d.label}</b><br>
                <i>${d.species}</i><br>
                ${d.note}
            `);

        const globeElement = document.getElementById('globeViz');
        GlobeObj(globeElement);

        GlobeObj.controls().autoRotate = true;
        GlobeObj.controls().autoRotateSpeed = 0.2;

        const slider = document.getElementById("monthSlider");
        const label = document.getElementById("monthLabel");

        function updateGlobe(monthIndex) {
            label.textContent = monthNames[monthIndex];
            const filtered = bloomData.filter(d => d.month === monthIndex);
            GlobeObj.pointsData(filtered);
        }

        updateGlobe(0);

        slider.addEventListener("input", e => {
            updateGlobe(parseInt(e.target.value));
        });

        (function animate() {
            GlobeObj.pointAltitude(d => 0.02 + 0.02 * Math.sin(Date.now() * 0.005 + d.lat));
            requestAnimationFrame(animate);
        })();

        let isPlaying = false;
        let playInterval;
        const playBtn = document.getElementById("playBtn");

        playBtn.addEventListener("click", () => {
            if (!isPlaying) {
                isPlaying = true;
                playBtn.textContent = "⏸ Pause";
                playInterval = setInterval(() => {
                    let nextMonth = (parseInt(slider.value) + 1) % 12;
                    slider.value = nextMonth;
                    updateGlobe(nextMonth);
                }, 1000);
            } else {
                isPlaying = false;
                playBtn.textContent = "▶ Play";
                clearInterval(playInterval);
            }
        });

        const locations = {
            "Japan": {"lat": 36.2048, "lon": 138.2529},
            "Alaska": {"lat": 64.2008, "lon": -149.4937},
            "Madagascar": {"lat": -18.7669, "lon": 46.8691},
            "New Zealand": {"lat": -40.9006, "lon": 174.8860},
            "Fiji": {"lat": -17.7134, "lon": 178.0650}
        };

        let currentLocation = 'Japan';
        let myChart;
        let selectedDataPointIndex = null;
        
        function generateNDVIDataForLocation(locationName, startDate, numMonths) {
            const dates = [];
            const ndvi = [];
            const start = new Date(startDate);
            let seasonalFactor, baseValue;

            switch(locationName) {
                case "Japan":
                    baseValue = 0.45;
                    seasonalFactor = 0.25;
                    break;
                case "Alaska":
                    baseValue = 0.2;
                    seasonalFactor = 0.6;
                    break;
                case "Madagascar":
                    baseValue = 0.7;
                    seasonalFactor = 0.08;
                    break;
                case "New Zealand":
                    baseValue = 0.5;
                    seasonalFactor = 0.2;
                    break;
                case "Fiji":
                    baseValue = 0.8;
                    seasonalFactor = 0.05;
                    break;
                default:
                    baseValue = 0.5;
                    seasonalFactor = 0.2;
            }

            for (let i = 0; i < numMonths; i++) {
                const date = new Date(start.getFullYear(), start.getMonth() + i, 1);
                dates.push(date);
                let month = date.getMonth();
                if (locationName === "New Zealand") {
                    month = (month + 6) % 12;
                }
                const value = baseValue + seasonalFactor * Math.sin(month * (Math.PI / 6)) + 0.03 * (Math.random() - 0.5);
                ndvi.push(Math.max(0, Math.min(1, value)));
            }
            return { dates, ndvi };
        }

        let fetchedNDVIData = {};
        
        async function fetchDataAndLoad() {
            const ndviData = {};
            const numMonths = 60;
            for (const loc in locations) {
                ndviData[loc] = generateNDVIDataForLocation(loc, '2018-01-01', numMonths);
            }
            return ndviData;
        }

        function updateChart(locationName) {
            currentLocation = locationName;
            const chartData = fetchedNDVIData[locationName];
            if (!chartData) return;

            document.getElementById('ndviChart').classList.remove('hidden');
            document.getElementById('chart-status').style.display = 'none';

            const monthlyAverages = new Array(12).fill(0);
            const monthlyCounts = new Array(12).fill(0);
            chartData.dates.forEach((date, i) => {
                const month = date.getMonth();
                monthlyAverages[month] += chartData.ndvi[i];
                monthlyCounts[month]++;
            });
            const seasonalPattern = monthlyAverages.map((sum, month) => sum / monthlyCounts[month]);

            const xMonths = Array.from({ length: chartData.dates.length }, (_, i) => i);
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
            const n = xMonths.length;
            for (let i = 0; i < n; i++) {
                sumX += xMonths[i];
                sumY += chartData.ndvi[i];
                sumXY += xMonths[i] * chartData.ndvi[i];
                sumX2 += xMonths[i] * xMonths[i];
            }
            const m = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);

            const futureDates = [];
            const predictedNDVI = [];
            const lastMonth = chartData.dates[chartData.dates.length - 1];
            for (let i = 1; i <= 12; i++) {
                const futureDate = new Date(lastMonth.getFullYear(), lastMonth.getMonth() + i, 1);
                const futureMonthIndex = futureDate.getMonth();
                const futureMonthTotalIndex = chartData.dates.length + i - 1;

                const prediction = seasonalPattern[futureMonthIndex] + (m * futureMonthTotalIndex);

                predictedNDVI.push(Math.max(0, Math.min(1, prediction)));
                futureDates.push(futureDate);
            }

            const allDates = chartData.dates.concat(futureDates);
            const allNDVI = chartData.ndvi.concat(predictedNDVI);
            const lastHistoricalIndex = chartData.dates.length - 1;

            const ctx = document.getElementById('ndviChart').getContext('2d');
            
            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allDates.map(d => d.toLocaleString('default', { month: 'short', year: 'numeric' })),
                    datasets: [
                        {
                            label: 'Historical NDVI',
                            data: chartData.ndvi,
                            borderColor: '#ad1c69',
                            backgroundColor: 'rgba(173, 28, 105, 0.2)',
                            pointBackgroundColor: '#ad1c69',
                            borderWidth: 2,
                            pointRadius: 3,
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'Predicted NDVI',
                            data: allNDVI,
                            borderColor: '#ff99c8',
                            backgroundColor: 'rgba(255, 153, 200, 0.2)',
                            pointBackgroundColor: '#ff99c8',
                            borderWidth: 2,
                            pointRadius: 3,
                            fill: false,
                            borderDash: [5, 5],
                            tension: 0.4,
                            pointStyle: (context) => {
                                const index = context.dataIndex;
                                if (index <= lastHistoricalIndex) {
                                    return 'circle';
                                } else {
                                    return 'star';
                                }
                            }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date',
                                color: '#9ca3af'
                            },
                            ticks: {
                                color: '#9ca3af',
                                autoSkip: true,
                                maxTicksLimit: 12
                            },
                            grid: {
                                color: 'rgba(156, 163, 175, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'NDVI (Vegetation Index)',
                                color: '#9ca3af'
                            },
                            min: 0,
                            max: 1,
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: 'rgba(156, 163, 175, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e5e7eb'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(31, 41, 55, 0.8)',
                            titleColor: '#e5e7eb',
                            bodyColor: '#9ca3af'
                        }
                    },
                    onClick: handleChartClick
                }
            });
            
            const infoPanel = document.getElementById('data-visualization-info');
            infoPanel.innerHTML = `
                <h3 class="text-xl font-semibold text-white/90 mb-2">${locationName}</h3>
                <p class="text-gray-400">Click on a data point to get an AI prediction for that month.</p>
            `;
            const selectedMonthInfo = document.getElementById('selected-month-info');
            selectedMonthInfo.classList.add('hidden');
        }

        function handleChartClick(event) {
            const points = myChart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
            if (points.length) {
                const firstPoint = points[0];
                const label = myChart.data.labels[firstPoint.index];
                const value = myChart.data.datasets[0].data[firstPoint.index];
                
                selectedDataPointIndex = firstPoint.index;
                const selectedMonthInfo = document.getElementById('selected-month-info');
                const selectedMonthText = document.getElementById('selected-month-text');
                selectedMonthText.textContent = label;
                selectedMonthInfo.classList.remove('hidden');
            }
        }

        function getPredictionForSelectedMonth() {
            if (selectedDataPointIndex === null) {
                document.getElementById('ai-response-container').textContent = "Please select a month on the chart first.";
                return;
            }
            
            const selectedMonth = myChart.data.labels[selectedDataPointIndex];
            const selectedValue = myChart.data.datasets[0].data[selectedDataPointIndex];
            const aiResponseContainer = document.getElementById('ai-response-container');

            aiResponseContainer.innerHTML = `<div class="loader mx-auto"></div> <span class="block text-center mt-2 text-gray-400">Thinking...</span>`;

            setTimeout(() => {
                const location = currentLocation;
                let response = "";

                if (myChart.data.datasets[1].data[selectedDataPointIndex] !== undefined) {
                    const predictedValue = myChart.data.datasets[1].data[selectedDataPointIndex];
                    response = `For ${location}, the AI predicts a Normalized Difference Vegetation Index (NDVI) of approximately ${predictedValue.toFixed(2)} in ${selectedMonth}. This is a predicted value based on an analysis of past trends and seasonal cycles.`;
                } else {
                    response = `For ${selectedMonth} in ${location}, the historical NDVI value was approximately ${selectedValue.toFixed(2)}. This value is a historical measurement from our satellite data.`;
                }
                
                aiResponseContainer.innerHTML = response;
            }, 1500);
        }

        function initMap() {
            if (typeof L === 'undefined') {
                console.error("Leaflet.js not loaded. Map cannot be initialized.");
                return;
            }
            const map = L.map('map').setView([20, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            for (const loc in locations) {
                const coords = locations[loc];
                const marker = L.marker([coords.lat, coords.lon]).addTo(map);
                marker.bindPopup(loc);
                marker.on('click', () => {
                    updateChart(loc);
                });
            }
        }
        
        function createCountryButtons() {
            const buttonContainer = document.getElementById('country-buttons-container');
            const locationsArray = Object.keys(locations);
            
            locationsArray.forEach(loc => {
                const button = document.createElement('button');
                button.textContent = loc;
                button.className = 'bg-[#ad1c69] text-white py-2 px-4 rounded-full transition-colors duration-200 hover:bg-[#85154f] focus:outline-none focus:ring-2 focus:ring-[#ad1c69] focus:ring-opacity-50';
                button.addEventListener('click', () => {
                    updateChart(loc);
                });
                buttonContainer.appendChild(button);
            });
        }
        
        window.onload = async () => {
            const chartStatus = document.getElementById('chart-status');
            const ndviChart = document.getElementById('ndviChart');
            const hdfFileInput = document.getElementById('hdf-file-input');
            const uploadStatusMessage = document.getElementById('upload-status-message');
            const getPredictionButton = document.getElementById('get-prediction-button');

            if (typeof Chart === 'undefined') {
                chartStatus.innerHTML = "Error: Chart.js failed to load. Please try again.";
                return;
            }
            
            try {
                chartStatus.textContent = "Fetching data...";
                fetchedNDVIData = await fetchDataAndLoad();
                chartStatus.textContent = "Data loaded.";
            } catch (error) {
                chartStatus.textContent = "Failed to load data. Please check the console for errors.";
                console.error("Initialization error:", error);
            }

            initMap();
            createCountryButtons();
            updateChart('Japan');
            
            if (getPredictionButton) {
                getPredictionButton.addEventListener('click', getPredictionForSelectedMonth);
            }

            hdfFileInput.addEventListener('change', (event) => {
                if (event.target.files.length > 0) {
                    uploadStatusMessage.className = 'text-sm text-yellow-400 mt-2';
                    uploadStatusMessage.textContent = 'Processing file...';

                    setTimeout(() => {
                        uploadStatusMessage.className = 'text-sm text-green-400 mt-2';
                        uploadStatusMessage.textContent = 'File uploaded successfully. Simulating data visualization. Please select a location to see the updated chart.';
                        updateChart(currentLocation);
                    }, 2000);
                }
            });
        };
    </script>
</body>
</html>
