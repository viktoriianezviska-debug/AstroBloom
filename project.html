<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Interactive NDVI Globe</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/three-globe"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
  body { margin: 0; font-family: 'Syne', sans-serif; background-color: #000; color: #ff66b2; overflow-x: hidden; }
  .controls { display: flex; align-items: center; gap: 10px; padding: 10px; }
  input[type=range] { width: 200px; }
  button { padding: 5px 10px; background: #ff1493; border: none; color: #fff; cursor: pointer; border-radius: 5px; }
  canvas { display: block; margin: 20px auto; max-width: 800px; background-color: #111; border-radius: 10px; }
  #data-visualization-info, #selected-month-info, #ai-response-container { text-align: center; margin-top: 10px; color: #ff66b2; }
  .hidden { display: none; }
  .loader { border: 5px solid #f3f3f3; border-top: 5px solid #ff1493; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; margin: 20px auto; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<!-- Globe container -->
<div id="globe-container" style="width:100%; height:400px;"></div>

<!-- Controls -->
<div class="controls">
  <input type="range" id="monthSlider" min="0" max="11" value="0">
  <span id="monthLabel">Jan</span>
  <button id="playBtn">▶ Play</button>
  <label><input type="checkbox" id="pollinatorToggle" checked> Show Pollinators</label>
  <label><input type="checkbox" id="ndviToggle" checked> Show NDVI</label>
</div>

<!-- NDVI Chart -->
<canvas id="ndviChart" class="hidden"></canvas>
<div id="chart-status">Loading...</div>

<!-- AI Prediction -->
<div id="data-visualization-info"></div>
<div id="selected-month-info" class="hidden">
  Selected month: <span id="selected-month-text"></span>
</div>
<div id="ai-response-container"></div>

<script>
/* --- Globals --- */
let GlobeObj;
const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
const slider = document.getElementById("monthSlider");
const label = document.getElementById("monthLabel");
const playBtn = document.getElementById("playBtn");

const locations = {
  "Japan": { lat: 36.2048, lon: 138.2529 },
  "Alaska": { lat: 64.2008, lon: -149.4937 },
  "Madagascar": { lat: -18.7669, lon: 46.8691 },
  "New Zealand": { lat: -40.9006, lon: 174.8860 },
  "Fiji": { lat: -17.7134, lon: 178.0650 }
};
let currentLocation = 'Japan';
let fetchedNDVIData = {};
let myChart;
let selectedDataPointIndex = null;
let isPlaying=false;
let playInterval;

/* --- Globe Initialization --- */
function initializeGlobe() {
  const container = document.getElementById('globe-container');
  GlobeObj = new ThreeGlobe()
    .globeImageUrl('//unpkg.com/three-globe/example/img/earth-dark.jpg')
    .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png');
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera();
  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(container.offsetWidth, container.offsetHeight);
  container.appendChild(renderer.domElement);
  scene.add(GlobeObj);
  camera.position.z = 2;
  (function animate() { requestAnimationFrame(animate); renderer.render(scene,camera); })();
}

function updateGlobe(monthIndex) {
  label.textContent = monthNames[monthIndex];
  // Placeholder: Extend with NDVI/pollinator visualization
}

/* --- Timeline Play Button --- */
function setupPlayButton() {
  playBtn.addEventListener("click",()=>{
    if(!isPlaying){
      isPlaying=true;
      playBtn.textContent="⏸ Pause";
      playInterval=setInterval(()=>{
        let nextMonth=(parseInt(slider.value)+1)%12;
        slider.value=nextMonth;
        updateGlobe(nextMonth);
      },1000);
    } else {
      isPlaying=false;
      playBtn.textContent="▶ Play";
      clearInterval(playInterval);
    }
  });
}

/* --- NDVI Data --- */
function generateNDVIDataForLocation(locationName, startDate, numMonths){
  const dates=[], ndvi=[];
  const start=new Date(startDate);
  let seasonalFactor, baseValue;
  switch(locationName){
    case "Japan": baseValue=0.45; seasonalFactor=0.25; break;
    case "Alaska": baseValue=0.2; seasonalFactor=0.6; break;
    case "Madagascar": baseValue=0.7; seasonalFactor=0.08; break;
    case "New Zealand": baseValue=0.5; seasonalFactor=0.2; break;
    case "Fiji": baseValue=0.8; seasonalFactor=0.05; break;
    default: baseValue=0.5; seasonalFactor=0.2;
  }
  for(let i=0;i<numMonths;i++){
    const date=new Date(start.getFullYear(), start.getMonth()+i,1);
    dates.push(date);
    let month=date.getMonth();
    if(locationName==="New Zealand") month=(month+6)%12;
    const value=baseValue+seasonalFactor*Math.sin(month*(Math.PI/6))+0.03*(Math.random()-0.5);
    ndvi.push(Math.max(0,Math.min(1,value)));
  }
  return {dates,ndvi};
}

async function fetchDataAndLoad(){
  const ndviData={}; const numMonths=60;
  for(const loc in locations) ndviData[loc]=generateNDVIDataForLocation(loc,'2018-01-01',numMonths);
  return ndviData;
}

/* --- Chart --- */
function updateChart(locationName){
  currentLocation=locationName;
  const chartData=fetchedNDVIData[locationName];
  if(!chartData) return;
  document.getElementById('ndviChart').classList.remove('hidden');
  document.getElementById('chart-status').style.display='none';

  const monthlyAverages=new Array(12).fill(0);
  const monthlyCounts=new Array(12).fill(0);
  chartData.dates.forEach((date,i)=>{
    const month=date.getMonth();
    monthlyAverages[month]+=chartData.ndvi[i];
    monthlyCounts[month]++;
  });
  const seasonalPattern=monthlyAverages.map((sum,month)=>sum/monthlyCounts[month]);
  const xMonths=Array.from({length:chartData.dates.length},(_,i)=>i);
  let sumX=0,sumY=0,sumXY=0,sumX2=0;
  const n=xMonths.length;
  for(let i=0;i<n;i++){
    sumX+=xMonths[i]; sumY+=chartData.ndvi[i]; sumXY+=xMonths[i]*chartData.ndvi[i]; sumX2+=xMonths[i]*xMonths[i];
  }
  const m=(n*sumXY-sumX*sumY)/(n*sumX2-sumX*sumX);

  const futureDates=[], predictedNDVI=[];
  const lastMonth=chartData.dates[chartData.dates.length-1];
  for(let i=1;i<=12;i++){
    const futureDate=new Date(lastMonth.getFullYear(), lastMonth.getMonth()+i,1);
    const futureMonthIndex=futureDate.getMonth();
    const futureMonthTotalIndex=chartData.dates.length+i-1;
    const prediction=seasonalPattern[futureMonthIndex]+(m*futureMonthTotalIndex);
    predictedNDVI.push(Math.max(0,Math.min(1,prediction)));
    futureDates.push(futureDate);
  }

  const allDates=chartData.dates.concat(futureDates);
  const allNDVI=chartData.ndvi.concat(predictedNDVI);
  const lastHistoricalIndex=chartData.dates.length-1;
  const ctx=document.getElementById('ndviChart').getContext('2d');
  if(myChart) myChart.destroy();

  myChart=new Chart(ctx,{
    type:'line',
    data:{
      labels:allDates.map(d=>d.toLocaleString('default',{month:'short',year:'numeric'})),
      datasets:[
        { label:'Historical NDVI', data:chartData.ndvi, borderColor:'#ff66b2', backgroundColor:'rgba(255,102,178,0.2)', pointBackgroundColor:'#ff66b2', borderWidth:2, pointRadius:3, fill:false, tension:0.4 },
        { label:'Predicted NDVI', data:allNDVI, borderColor:'#ff1493', backgroundColor:'rgba(255,20,147,0.2)', pointBackgroundColor:'#ff1493', borderWidth:2, pointRadius:3, fill:false, borderDash:[5,5], tension:0.4, pointStyle: context => context.dataIndex<=lastHistoricalIndex?'circle':'star' }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{ x:{ ticks:{color:'#ffb6c1'}, grid:{color:'rgba(255,182,193,0.1)'} }, y:{ min:0,max:1, ticks:{color:'#ffb6c1'}, grid:{color:'rgba(255,182,193,0.1)'} } },
      plugins:{ legend:{ labels:{ color:'#ffb6c1' } }, tooltip:{ backgroundColor:'rgba(31,41,55,0.8)', titleColor:'#ffb6c1', bodyColor:'#ffb6c1' } },
      onClick: handleChartClick
    }
  });

  document.getElementById('data-visualization-info').innerHTML=`<h3>${locationName}</h3><p>Click on a point to see AI prediction</p>`;
  document.getElementById('selected-month-info').classList.add('hidden');
}

function handleChartClick(event){
  const points=myChart.getElementsAtEventForMode(event,'nearest',{intersect:true},true);
  if(points.length){
    selectedDataPointIndex=points[0].index;
    document.getElementById('selected-month-text').textContent=myChart.data.labels[selectedDataPointIndex];
    document.getElementById('selected-month-info').classList.remove('hidden');
  }
}

function getPredictionForSelectedMonth(){
  if(selectedDataPointIndex===null){ document.getElementById('ai-response-container').textContent="Select a month first."; return; }
  const selectedMonth=myChart.data.labels[selectedDataPointIndex];
  const selectedValue=myChart.data.datasets[0].data[selectedDataPointIndex];
  const aiResponseContainer=document.getElementById('ai-response-container');
  aiResponseContainer.innerHTML=`<div class="loader"></div><span>Thinking...</span>`;
  setTimeout(()=>{
    const location=currentLocation;
    let response="";
    if(myChart.data.datasets[1].data[selectedDataPointIndex]!==undefined){
      response=`AI predicts NDVI ≈ ${myChart.data.datasets[1].data[selectedDataPointIndex].toFixed(2)} in ${selectedMonth} for ${location}.`;
    } else {
      response=`Historical NDVI ≈ ${selectedValue.toFixed(2)} in ${selectedMonth} for ${location}.`;
    }
    aiResponseContainer.innerHTML=response;
  },1500);
}

/* --- Event Listeners --- */
slider.addEventListener("input",e=>updateGlobe(parseInt(e.target.value)));
setupPlayButton();
document.getElementById('pollinatorToggle').addEventListener('change',()=>updateGlobe(parseInt(slider.value)));
document.getElementById('ndviToggle').addEventListener('change',()=>updateGlobe(parseInt(slider.value)));

/* --- Init --- */
window.onload=async()=>{
  try{
    fetchedNDVIData=await fetchDataAndLoad();
  } catch(err){ console.error(err); document.getElementById('chart-status').textContent="Failed to load data."; }
  initializeGlobe();
  updateGlobe(0);
  updateChart('Japan');
  // Optional: Button for AI prediction
  const btn=document.createElement('button'); btn.textContent='Get Prediction'; btn.onclick=getPredictionForSelectedMonth;
  document.body.appendChild(btn);
};
</script>
</body>
</html>
