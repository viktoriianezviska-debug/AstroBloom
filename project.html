<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AstroBloom Project</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://unpkg.com/three"></script>
<script src="https://unpkg.com/globe.gl"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
/* General resets and custom font */
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; font-family: 'Syne', sans-serif; }

/* Styling for the globe visualization */
#globeViz {
    width: 100%;
    height: 70vh;
}
#map {
    width: 100%;
    height: 500px;
    border-radius: 1rem;
    z-index: 10;
}
/* For the file input to be styled consistently */
input[type="file"] {
    cursor: pointer;
}
</style>
</head>
<body class="bg-gray-950 text-white min-h-screen flex flex-col items-center">

<!-- Header Section -->
<header class="w-full fixed top-0 left-0 bg-gray-950/80 backdrop-blur-sm z-50 py-4 shadow-lg">
    <nav class="container mx-auto flex justify-center space-x-8">
        <a href="#" class="text-white text-lg font-bold hover:text-pink-400 transition-colors">Home</a>
        <a href="#" class="text-white text-lg font-bold hover:text-pink-400 transition-colors">Project</a>
        <a href="#" class="text-white text-lg font-bold hover:text-pink-400 transition-colors">About</a>
    </nav>
</header>

<main class="w-full pt-20 pb-16 px-4 md:px-8 max-w-7xl mx-auto">

    <!-- Globe Section -->
    <section class="relative w-full rounded-3xl overflow-hidden shadow-2xl mb-12 bg-gray-900">
        <div id="globeViz" class="w-full h-[70vh] md:h-[80vh]"></div>
        <div id="sliderContainer" class="absolute bottom-6 left-1/2 -translate-x-1/2 w-full max-w-2xl px-4 text-center">
            <span id="monthLabel" class="text-xl font-bold text-gray-200">January</span>
            <input type="range" id="monthSlider" min="0" max="11" step="1" value="0" class="w-full h-2 bg-pink-400 rounded-lg appearance-none cursor-pointer mt-2">
            <button id="playBtn" class="mt-4 px-6 py-2 bg-pink-500 hover:bg-pink-600 transition-colors text-white font-bold rounded-full shadow-lg">▶ Play</button>
        </div>
    </section>

    <!-- Main Content Grid: Chart/Info and Map -->
    <section class="w-full grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
        
        <!-- Left Column: Chart, AI, Upload -->
        <div class="lg:col-span-1 space-y-8">
            <!-- Chart Card -->
            <div class="bg-gray-900 p-6 rounded-3xl shadow-2xl transition-all hover:shadow-pink-400/10">
                <h3 class="text-2xl font-bold text-white mb-4">NDVI Trend & Prediction</h3>
                <div class="h-64">
                    <canvas id="ndviChart" class="hidden"></canvas>
                    <div id="chart-status" class="flex items-center justify-center h-full text-gray-400">Loading chart...</div>
                </div>
            </div>

            <!-- AI Prediction Section -->
            <div class="bg-gray-900 p-6 rounded-3xl shadow-2xl transition-all hover:shadow-pink-400/10">
                <h3 class="text-2xl font-bold text-white mb-4">AI Prediction</h3>
                <div id="ai-response-container" class="bg-gray-800 text-gray-300 p-4 rounded-xl shadow-inner min-h-[5rem]">
                    AI responses will appear here. Click a data point on the chart and then click "Get AI Prediction" for more info.
                </div>
                <div id="selected-month-info" class="mt-4 hidden">
                    <span class="text-white font-bold">Selected Month: </span><span id="selected-month-text" class="text-pink-400"></span>
                    <button id="get-prediction-button" class="ml-4 px-4 py-1.5 bg-pink-500 hover:bg-pink-600 transition-colors text-white font-bold rounded-full shadow-lg">Get AI Prediction</button>
                </div>
            </div>

            <!-- Data Upload -->
            <div class="bg-gray-900 p-6 rounded-3xl shadow-2xl transition-all hover:shadow-pink-400/10">
                <h3 class="text-2xl font-bold text-white mb-4">Upload Data</h3>
                <div class="flex flex-col space-y-2">
                    <label for="hdf-file-input" class="block text-gray-300 font-medium">Upload a MODIS HDF file:</label>
                    <input type="file" id="hdf-file-input" accept=".hdf" class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-pink-50 file:text-pink-700
                        hover:file:bg-pink-100 cursor-pointer transition-colors
                    ">
                    <p id="upload-status-message" class="text-sm text-gray-500 mt-2"></p>
                </div>
            </div>
        </div>

        <!-- Right Column: Map -->
        <div class="lg:col-span-2 rounded-3xl overflow-hidden shadow-2xl">
            <div id="map" class="w-full h-full"></div>
        </div>
    </section>

    <!-- Footer Strip -->
    <div class="strip w-full bg-gray-900 py-6 px-8 text-center rounded-3xl shadow-xl">
        <h2 class="text-xl md:text-2xl font-semibold">Connecting science with practical applications and insights.</h2>
    </div>

</main>

<script>
/* ---------------- GLOBE ---------------- */
const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const bloomData = [];

function addBloom(lat,lng,month,info,count=10,spread=3){
  for(let i=0;i<count;i++){
    bloomData.push({
      lat:lat+(Math.random()-0.5)*spread,
      lng:lng+(Math.random()-0.5)*spread,
      month,
      ...info
    });
  }
}

// Japan
["#e8eb49ff","#f5a2acff","#f484d4ff","#e647b9ff","#ab8aecff","#d56de3ff","#e898ecff","#f399f0ff","#de4242ff","#c27d37ff","#e16473ff","#f1ebb2ff"]
.forEach((color,i)=>{addBloom(36.2,138.2,i,{color,label:"Japan",species:"Cherry Blossom - Sakura",note:"Cultural symbol, peak bloom in spring; critical for pollinators."},15,5)});

// Alaska
["#83b1ddff","#649ac8ff","#a2d7ecff","#6a5acd","#8f2da0ff","#d25db9ff","#cad239ff","#d9eaa5ff","#94dee1ff","#5cabcaff","#34879eff","#4b6cb1ff"]
.forEach((color,i)=>{addBloom(64.2,-149.5,i,{color,label:"Alaska",species:"Lupine and Arctic Poppy",note:"Short growing season; blooms support insects."},12,6)});

// Madagascar
["#2e7d32","#4b9d4fff","#6bc56fff","#e1a2d6ff","#8be0ddff","#98d6e7ff","#8ae5e5ff","#9adbedff","#c71585","#edb232ff","#e2b330ff","#b288d1ff"]
.forEach((color,i)=>{addBloom(-18.9,47.5,i,{color,label:"Madagascar",species:"Baobab and Traveler's Palm",note:"Unique flora; blooms influence lemur feeding and pollination."},15,5)});

// New Zealand
["#ff1493","#ff1493","#ff8c00","#b22222","#b22222","#778899","#87ceeb","#ffb6c1","#ffff00","#e3e54eff","#cb84c9ff","#b52212ff"]
.forEach((color,i)=>{addBloom(-40.9,174.9,i,{color,label:"New Zealand Bloom",species:"Kōwhai and Pohutukawa",note:"Seasonal shifts vital for native birds like tui and bellbirds."},15,5)});

// Fiji
["#ebe41fff","#efa3eeff","#e28ee8ff","#ef6caeff","#ea9cd4ff","#da48c2ff","#ffffff","#ff4500","#ea8ecbff","#edaa92ff","#eea58bff","#e69a87ff"]
.forEach((color,i)=>{addBloom(-17.7,178.1,i,{color,label:"Fiji",species:"Hibiscus and Breadfruit",note:"Blooms tied to rainfall cycles; important for pollinators and agriculture."},15,5)});

const GlobeObj = Globe()
  .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
  .pointAltitude(d=>0.02+0.02*Math.sin(Date.now()*0.005+d.lat))
  .pointRadius(0.4)
  .pointColor(d=>d.color)
  .pointLabel(d=>`<b>${d.label}</b><br><i>${d.species}</i><br>${d.note}`);

GlobeObj(document.getElementById('globeViz'));
GlobeObj.controls().autoRotate = true;
GlobeObj.controls().autoRotateSpeed = 0.2;

const slider = document.getElementById("monthSlider");
const label = document.getElementById("monthLabel");
function updateGlobe(monthIndex){
  label.textContent = monthNames[monthIndex];
  const filtered = bloomData.filter(d=>d.month===monthIndex);
  GlobeObj.pointsData(filtered);
}
updateGlobe(0);
slider.addEventListener("input", e=>updateGlobe(parseInt(e.target.value)));
(function animate(){GlobeObj.pointAltitude(d=>0.02+0.02*Math.sin(Date.now()*0.005+d.lat));requestAnimationFrame(animate)})();

let isPlaying=false; let playInterval;
document.getElementById("playBtn").addEventListener("click", ()=>{
  if(!isPlaying){isPlaying=true; this.textContent="⏸ Pause"; playInterval=setInterval(()=>{
    let nextMonth=(parseInt(slider.value)+1)%12; slider.value=nextMonth; updateGlobe(nextMonth);
  },1000);} else {isPlaying=false; this.textContent="▶ Play"; clearInterval(playInterval);}
});

/* ---------------- CHART & MAP ---------------- */
const locations={
  "Japan":{"lat":36.2048,"lon":138.2529},
  "Alaska":{"lat":64.2008,"lon":-149.4937},
  "Madagascar":{"lat":-18.7669,"lon":46.8691},
  "New Zealand":{"lat":-40.9006,"lon":174.8860},
  "Fiji":{"lat":-17.7134,"lon":178.0650}
};

let currentLocation="Japan"; let myChart; let selectedDataPointIndex=null; let fetchedNDVIData={};

function generateNDVIDataForLocation(locationName,startDate,numMonths){
  const dates=[], ndvi=[]; const start=new Date(startDate);
  let seasonalFactor, baseValue;
  switch(locationName){
    case"Japan": baseValue=0.45; seasonalFactor=0.25; break;
    case"Alaska": baseValue=0.2; seasonalFactor=0.6; break;
    case"Madagascar": baseValue=0.7; seasonalFactor=0.08; break;
    case"New Zealand": baseValue=0.5; seasonalFactor=0.2; break;
    case"Fiji": baseValue=0.8; seasonalFactor=0.05; break;
    default: baseValue=0.5; seasonalFactor=0.2;
  }
  for(let i=0;i<numMonths;i++){
    const date=new Date(start.getFullYear(), start.getMonth()+i,1);
    dates.push(date);
    let month=date.getMonth();
    if(locationName==="New Zealand") month=(month+6)%12;
    const value=baseValue+seasonalFactor*Math.sin(month*(Math.PI/6))+0.03*(Math.random()-0.5);
    ndvi.push(Math.max(0,Math.min(1,value)));
  }
  return {dates, ndvi};
}

async function fetchDataAndLoad(){
  const ndviData={}; const numMonths=60;
  for(const loc in locations){ ndviData[loc]=generateNDVIDataForLocation(loc,'2018-01-01',numMonths);}
  return ndviData;
}

function updateChart(locationName){
  currentLocation=locationName;
  const chartData=fetchedNDVIData[locationName]; if(!chartData) return;
  document.getElementById('ndviChart').classList.remove('hidden'); document.getElementById('chart-status').style.display='none';
  const monthlyAverages=new Array(12).fill(0), monthlyCounts=new Array(12).fill(0);
  chartData.dates.forEach((date,i)=>{ const month=date.getMonth(); monthlyAverages[month]+=chartData.ndvi[i]; monthlyCounts[month]++; });
  const seasonalPattern=monthlyAverages.map((sum,month)=>sum/monthlyCounts[month]);
  const xMonths=chartData.dates.map((_,i)=>i); let sumX=0,sumY=0,sumXY=0,sumX2=0; const n=xMonths.length;
  for(let i=0;i<n;i++){sumX+=xMonths[i]; sumY+=chartData.ndvi[i]; sumXY+=xMonths[i]*chartData.ndvi[i]; sumX2+=xMonths[i]*xMonths[i];}
  const m=(n*sumXY-sumX*sumY)/(n*sumX2-sumX*sumX);
  const futureDates=[], predictedNDVI=[]; const lastMonth=chartData.dates[chartData.dates.length-1];
  for(let i=1;i<=12;i++){ const futureDate=new Date(lastMonth.getFullYear(), lastMonth.getMonth()+i,1); const futureMonthIndex=futureDate.getMonth(); const futureMonthTotalIndex=chartData.dates.length+i-1; const prediction=seasonalPattern[futureMonthIndex]+(m*futureMonthTotalIndex); predictedNDVI.push(Math.max(0,Math.min(1,prediction))); futureDates.push(futureDate);}
  const allDates=chartData.dates.concat(futureDates); const allNDVI=chartData.ndvi.concat(predictedNDVI); const lastHistoricalIndex=chartData.dates.length-1;
  const ctx=document.getElementById('ndviChart').getContext('2d');
  if(myChart) myChart.destroy();
  myChart=new Chart(ctx,{
    type:'line',
    data:{labels:allDates.map(d=>d.toLocaleString('default',{month:'short',year:'numeric'})),
      datasets:[
        {label:'Historical NDVI', data:chartData.ndvi, borderColor:'#8b5cf6', backgroundColor:'rgba(139,92,246,0.2)', pointBackgroundColor:'#8b5cf6', borderWidth:2, pointRadius:3, fill:false, tension:0.4},
        {label:'Predicted NDVI', data:allNDVI, borderColor:'#ec4899', backgroundColor:'rgba(236,72,153,0.2)', pointBackgroundColor:'#ec4899', borderWidth:2, pointRadius:3, fill:false, borderDash:[5,5], tension:0.4, pointStyle:(context)=>{const index=context.dataIndex; return index<=lastHistoricalIndex?'circle':'star';}}
      ]},
    options:{responsive:true, maintainAspectRatio:false, scales:{x:{ticks:{color:'#9ca3af'}, grid:{color:'rgba(156,163,175,0.1)'}}, y:{min:0,max:1,ticks:{color:'#9ca3af'}, grid:{color:'rgba(156,163,175,0.1)'}}}, plugins:{legend:{labels:{color:'#e5e7eb'}}, tooltip:{backgroundColor:'rgba(31,41,55,0.8)',titleColor:'#e5e7eb',bodyColor:'#9ca3af'}}, onClick:handleChartClick}});
  const infoPanel=document.getElementById('data-visualization-info'); if(infoPanel) infoPanel.innerHTML=`<h3>${locationName}</h3><p>Click a data point to get an AI prediction.</p>`;
  document.getElementById('selected-month-info').style.display='none';
}

function handleChartClick(event){
  const points=myChart.getElementsAtEventForMode(event,'nearest',{intersect:true},true);
  if(points.length){ const firstPoint=points[0]; const label=myChart.data.labels[firstPoint.index]; selectedDataPointIndex=firstPoint.index;
    document.getElementById('selected-month-text').textContent=label;
    document.getElementById('selected-month-info').style.display='inline-block';
  }
}

function getPredictionForSelectedMonth(){
  if(selectedDataPointIndex===null){document.getElementById('ai-response-container').textContent="Please select a month first."; return;}
  const selectedMonth=myChart.data.labels[selectedDataPointIndex]; const selectedValue=myChart.data.datasets[0].data[selectedDataPointIndex]; const predictedValue=myChart.data.datasets[1].data[selectedDataPointIndex];
  const aiResponseContainer=document.getElementById('ai-response-container'); aiResponseContainer.textContent='Thinking...';
  setTimeout(()=>{aiResponseContainer.textContent=`For ${currentLocation}, the predicted NDVI for ${selectedMonth} is approximately ${predictedValue.toFixed(2)}.`;},1500);
}

function initMap(){
  const map=L.map('map').setView([20,0],2);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{subdomains:'abcd',maxZoom:19}).addTo(map);
  for(const loc in locations){const c=locations[loc]; const marker=L.marker([c.lat,c.lon]).addTo(map); marker.bindPopup(loc); marker.on('click',()=>updateChart(loc));}
}

window.onload=async()=>{
  fetchedNDVIData=await fetchDataAndLoad();
  updateChart('Japan');
  initMap();
  document.getElementById('get-prediction-button').addEventListener('click', getPredictionForSelectedMonth);
  document.getElementById('hdf-file-input').addEventListener('change', (event)=>{
    if(event.target.files.length>0){ const msg=document.getElementById('upload-status-message'); msg.textContent='Processing...'; setTimeout(()=>{msg.textContent='File uploaded successfully.'; updateChart(currentLocation);},1500);}
  });
};
</script>

</body>
</html>
