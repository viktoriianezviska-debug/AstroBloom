<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Astrobloom Interactive Globe</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/three"></script>
  <script src="https://unpkg.com/globe.gl"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --accent: #ff2d84;
      --panel: #1a001f;
      --muted: #b8a0b8;
      font-family: 'Syne', sans-serif;
    }

    html,
    body {
      height: auto; /* Changed to auto */
      margin: 0;
      background: #000;
      color: #fff;
      font-family: 'Syne', sans-serif;
      overflow-x: hidden; /* Prevent horizontal scroll */
    }

    .container {
      display: flex;
      flex-direction: column; /* Stack items vertically */
      align-items: center; /* Center items horizontally */
      padding: 20px; /* Add padding around the content */
    }

    .globe-section {
      width: 90%; /* Make globe section responsive */
      max-width: 800px; /* Limit maximum width */
      margin-bottom: 20px; /* Add spacing between sections */
    }

    #globeViz {
      width: 100%; /* Make globe fill its container */
      height: 400px; /* Fixed height for the globe */
      background: transparent;
    }

    .globe-controls {
      text-align: center;
      color: white;
      font-size: 1.2em;
      margin-top: 10px;
    }

    .globe-controls input[type="range"] {
      width: 60%;
    }

    .dashboard-section {
      width: 90%; /* Make dashboard section responsive */
      max-width: 800px; /* Limit maximum width */
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .chart-card {
      background: transparent;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 1.5rem;
    }

    #country-buttons-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Responsive grid */
      gap: 8px;
    }

    #country-buttons-container button {
      background: transparent;
      border: 1px solid var(--accent);
      color: #ffd6ea;
      padding: 6px 8px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 1em;
      margin-bottom: 2px;
    }

    #ai-response-container {
      min-height: 48px;
      padding: 8px;
      color: #f3d1e3;
      background: transparent;
      border-radius: 8px;
      font-size: 1em;
    }

    #selected-month-info {
      margin-top: 8px;
      display: none;
    }

    #selected-month-info span {
      color: #ffd6ea;
      font-weight: 600;
    }

    #selected-month-text {
      color: var(--accent);
      margin-left: 4px;
    }

    #get-prediction-button {
      margin-left: 10px;
      background: transparent;
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    #hdf-file-input {
      width: 100%;
      margin-top: 8px;
      color: #ffd6ea;
      background: transparent;
      border-radius: 8px;
      border: 1px solid var(--accent);
      padding: 4px;
    }

    #upload-status-message {
      color: var(--muted);
      font-size: 0.95em;
      margin-top: 6px;
    }

    .muted {
      color: var(--muted);
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Globe Section -->
    <div class="globe-section">
      <div id="globeViz"></div>
      <div class="globe-controls">
        <span id="monthLabel">January</span>
        <input type="range" id="monthSlider" min="0" max="11" step="1" value="0">
        <button id="playBtn">▶ Play</button>
        <label><input type="checkbox" id="pollinatorToggle" checked> Pollinators</label>
        <label><input type="checkbox" id="ndviToggle"> NDVI</label>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div class="dashboard-section">
      <h2 class="text-2xl font-bold text-white/90">Data Visualisation</h2>
      <div id="data-visualization-info" class="text-gray-400">
        <p>Click a marker on the map or a button below to see its NDVI trend and prediction.</p>
      </div>

      <div class="chart-card">
        <h3 class="text-lg font-semibold text-white/90 mb-2">NDVI Trend & Prediction</h3>
        <div id="chart-container-wrapper" class="chart-container flex justify-center items-center">
          <canvas id="ndviChart" class="hidden"></canvas>
          <div id="chart-status" class="text-gray-400">Loading chart...</div>
        </div>
      </div>

      <div class="chart-card">
        <h3 class="text-2xl font-bold text-white/90 mb-2">AI Prediction</h3>
        <div id="ai-response-container" class="bg-black text-gray-300 p-4 rounded-lg shadow-inner min-h-[5rem]">
          AI responses will appear here. Click a data point on the chart and then click "Get AI Prediction" for more
          info.
        </div>
        <div id="selected-month-info" class="mt-4 hidden">
          <span class="text-white font-medium">Selected Month: </span><span id="selected-month-text"
            class="text-blue-400"></span>
          <button id="get-prediction-button"
            class="ml-4 bg-blue-600 text-white py-1 px-3 rounded-full hover:bg-blue-700">Get AI Prediction</button>
        </div>
      </div>

      <div class="chart-card">
        <h3 class="text-xl font-semibold text-white/90 mb-4">Select a Country</h3>
        <div id="country-buttons-container" class="grid grid-cols-3 md:grid-cols-3 gap-3">
        </div>
      </div>

      <div class="chart-card">
        <h3 class="text-2xl font-bold text-white/90 mb-2">Upload Data</h3>
        <div class="flex flex-col space-y-2">
          <label for="hdf-file-input" class="block text-gray-400 font-medium">Upload a MODIS HDF file:</label>
          <input type="file" id="hdf-file-input" accept=".hdf"
            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
          <p id="upload-status-message" class="text-sm text-gray-500 mt-2"></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const bloomData = [];

    function addBloom(lat, lng, month, info, count = 10, spread = 3) {
      for (let i = 0; i < count; i++) {
        bloomData.push({
          lat: lat + (Math.random() - 0.5) * spread,
          lng: lng + (Math.random() - 0.5) * spread,
          month,
          ...info // spreads color, label, species, note
        });
      }
    }

    // --- BLOOM DATA WITH SPECIES + NOTES ---
    // Japan (Cherry Blossom + seasonal shifts)
    ["#e8eb49ff", "#f5a2acff", "#f484d4ff", "#e647b9ff", "#ab8aecff", "#d56de3ff", "#e898ecff", "#f399f0ff", "#de4242ff", "#c27d37ff", "#e16473ff", "#f1ebb2ff"].forEach((color, i) => {
      addBloom(36.2, 138.2, i, {
        color,
        label: "Japan",
        species: "Cherry Blossom - Sakura",
        note: "Cultural symbol, peak bloom in spring; critical for pollinators."
      }, 15, 5);
    });
    // Alaska (Wildflowers + tundra plants)
    ["#83b1ddff", "#649ac8ff", "#a2d7ecff", "#6a5acd", "#8f2da0ff", "#d25db9ff", "#cad239ff", "#d9eaa5ff", "#94dee1ff", "#5cabcaff", "#34879eff", "#4b6cb1ff"].forEach((color, i) => {
      addBloom(64.2, -149.5, i, {
        color,
        label: "Alaska",
        species: "Lupine and Arctic Poppy",
        note: "Short growing season; blooms support insects."
      }, 12, 6);
    });
    // Madagascar (Baobabs + tropical flowers)
    ["#2e7d32", "#4b9d4fff", "#6bc56fff", "#e1a2d6ff", "#8be0ddff", "#98d6e7ff", "#8ae5e5ff", "#9adbedff", "#c71585", "#edb232ff", "#e2b330ff", "#b288d1ff"].forEach((color, i) => {
      addBloom(-18.9, 47.5, i, {
        color,
        label: "Madagascar",
        species: "Baobab and Traveler's Palm",
        note: "Unique flora; blooms influence lemur feeding and pollination."
      }, 15, 5);
    });
    // New Zealand (Kōwhai + native shrubs)
    ["#ff1493", "#ff1493", "#ff8c00", "#b22222", "#b22222", "#778899", "#87ceeb", "#ffb6c1", "#ffff00", "#e3e54eff", "#cb84c9ff", "#b52212ff"].forEach((color, i) => {
      addBloom(-40.9, 174.9, i, {
        color,
        label: "New Zealand Bloom",
        species: "Kōwhai and Pohutukawa",
        note: "Seasonal shifts vital for native birds like tui and bellbirds."
      }, 15, 5);
    });
    // Fiji (Hibiscus + tropical crops)
    ["#ebe41fff", "#efa3eeff", "#e28ee8ff", "#ef6caeff", "#ea9cd4ff", "#da48c2ff", "#ffffff", "#ff4500", "#ea8ecbff", "#edaa92ff", "#eea58bff", "#e69a87ff"].forEach((color, i) => {
      addBloom(-17.7, 178.1, i, {
        color,
        label: "Fiji",
        species: "Hibiscus and Breadfruit",
        note: "Blooms tied to rainfall cycles; important for pollinators and agriculture."
      }, 15, 5);
    });

    let GlobeObj; // Declare GlobeObj outside the function

    function initializeGlobe() {
      GlobeObj = Globe()
        .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
        .backgroundColor('rgba(0,0,0,0)')
        .pointAltitude(d => 0.02 + 0.02 * Math.sin(Date.now() * 0.005 + d.lat))
        .pointRadius(0.4)
        .pointColor(d => d.color)
        .pointLabel(d => `
            <b>${d.label}</b>
            <i>${d.species}</i>
            ${d.note}
          `);
      const globeElement = document.getElementById('globeViz');
      GlobeObj(globeElement);
      // Auto-rotate slower
      GlobeObj.controls().autoRotate = true;
      GlobeObj.controls().autoRotateSpeed = 0.1; // slower rotation
    }

    function ndviColor(v) {
      const g = Math.round(200 * v + 40);
      const r = Math.round((1 - v) * 180 + 40);
      const b = Math.round((1 - v) * 60 + 20);
      return `rgba(${r},${g},${b},0.9)`;
    }

    function updateGlobe(monthIndex) {
      const filtered = bloomData.filter(d => d.month === monthIndex);
      const pollOn = document.getElementById('pollinatorToggle').checked;
      const ndviOn = document.getElementById('ndviToggle').checked;
      const pts = [];

      if (pollOn) pts.push(...filtered.map(p => ({ ...p, _type: 'pollinator', _radiusOverride: 0.28 })));
      if (ndviOn) pts.push(...filtered.map(p => ({
        ...p,
        _type: 'ndvi',
        color: ndviColor(p.ndvi),
        _radiusOverride: 0.28 + p.ndvi * 0.6
      })));

      GlobeObj.pointColor(d => d.color || (d._type === 'ndvi' ? ndviColor(d.ndvi || 0.4) : '#ff2d84'));
      GlobeObj.pointRadius(d => d._radiusOverride || 0.32);
      GlobeObj.pointsData(pts);
    }

    // Timeline slider logic
    const slider = document.getElementById("monthSlider");
    const label = document.getElementById("monthLabel");

    function updateGlobeText(monthIndex) {
      label.textContent = monthNames[monthIndex];
      updateGlobe(monthIndex);
    }

    // --- Play Button Logic ---
    let isPlaying = false;
    let playInterval;
    const playBtn = document.getElementById("playBtn");

    function setupPlayButton() {
      playBtn.addEventListener("click", () => {
        if (!isPlaying) {
          isPlaying = true;
          playBtn.textContent = "⏸ Pause";
          playInterval = setInterval(() => {
            let nextMonth = (parseInt(slider.value) + 1) % 12;
            slider.value = nextMonth;
            updateGlobeText(nextMonth);
          }, 1000); // 1 second per month
        } else {
          isPlaying = false;
          playBtn.textContent = "▶ Play";
          clearInterval(playInterval);
        }
      });
    }

    // --- Country Button Logic ---
    function createCountryButtons() {
      const buttonContainer = document.getElementById('country-buttons-container');
      const locationsArray = Object.keys(locations);

      locationsArray.forEach(loc => {
        const button = document.createElement('button');
        button.textContent = loc;
        button.addEventListener('click', () => {
          flyToLocation(locations[loc].lat, locations[loc].lon);
          updateChart(loc);
        });
        buttonContainer.appendChild(button);
      });
    }

    function flyToLocation(lat, lng) {
      GlobeObj.cameraLookAt({ lat, lng, altitude: 1.5 });
    }

    document.getElementById('pollinatorToggle').addEventListener('change', () => updateGlobeText(parseInt(slider.value)));
    document.getElementById('ndviToggle').addEventListener('change', () => updateGlobeText(parseInt(slider.value)));

    const locations = {
      "Japan": { "lat": 36.2048, "lon": 138.2529 },
      "Alaska": { "lat": 64.2008, "lon": -149.4937 },
      "Madagascar": { "lat": -18.7669, "lon": 46.8691 },
      "New Zealand": { "lat": -40.9006, "lon": 174.8860 },
      "Fiji": { "lat": -17.7134, "lon": 178.0650 }
    };
    let currentLocation = 'Japan';
    let myChart;
    let selectedDataPointIndex = null;

    function generateNDVIDataForLocation(locationName, startDate, numMonths) {
      const dates = [];
      const ndvi = [];
      const start = new Date(startDate);
      let seasonalFactor, baseValue;
      switch (locationName) {
        case "Japan":
          baseValue = 0.45;
          seasonalFactor = 0.25;
          break;
        case "Alaska":
          baseValue = 0.2;
          seasonalFactor = 0.6;
          break;
        case "Madagascar":
          baseValue = 0.7;
          seasonalFactor = 0.08;
          break;
        case "New Zealand":
          baseValue = 0.5;
          seasonalFactor = 0.2;
          break;
        case "Fiji":
          baseValue = 0.8;
          seasonalFactor = 0.05;
          break;
        default:
          baseValue = 0.5;
          seasonalFactor = 0.2;
      }
      for (let i = 0; i < numMonths; i++) {
        const date = new Date(start.getFullYear(), start.getMonth() + i, 1);
        dates.push(date);
        let month = date.getMonth();
        if (locationName === "New Zealand") {
          month = (month + 6) % 12;
        }
        const value = baseValue + seasonalFactor * Math.sin(month * (Math.PI / 6)) + 0.03 * (Math.random() - 0.5);
        ndvi.push(Math.max(0, Math.min(1, value)));
      }
      return { dates, ndvi };
    }
    let fetchedNDVIData = {};

    async function fetchDataAndLoad() {
      const ndviData = {};
      const numMonths = 60; // 5 years of data
      for (const loc in locations) {
        ndviData[loc] = generateNDVIDataForLocation(loc, '2018-01-01', numMonths);
      }
      return ndviData;
    }

    function updateChart(locationName) {
      currentLocation = locationName;
      const chartData = fetchedNDVIData[locationName];
      if (!chartData) return;
      document.getElementById('ndviChart').classList.remove('hidden');
      document.getElementById('chart-status').style.display = 'none';
      const monthlyAverages = new Array(12).fill(0);
      const monthlyCounts = new Array(12).fill(0);
      chartData.dates.forEach((date, i) => {
        const month = date.getMonth();
        monthlyAverages[month] += chartData.ndvi[i];
        monthlyCounts[month]++;
      });
      const seasonalPattern = monthlyAverages.map((sum, month) => sum / monthlyCounts[month]);
      const xMonths = Array.from({ length: chartData.dates.length }, (_, i) => i);
      let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
      const n = xMonths.length;
      for (let i = 0; i < n; i++) {
        sumX += xMonths[i];
        sumY += chartData.ndvi[i];
        sumXY += xMonths[i] * chartData.ndvi[i];
        sumX2 += xMonths[i] * xMonths[i];
      }
      const m = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
      const futureDates = [];
      const predictedNDVI = [];
      const lastMonth = chartData.dates[chartData.dates.length - 1];
      for (let i = 1; i <= 12; i++) {
        const futureDate = new Date(lastMonth.getFullYear(), lastMonth.getMonth() + i, 1);
        const futureMonthIndex = futureDate.getMonth();
        const futureMonthTotalIndex = chartData.dates.length + i - 1;
        const prediction = seasonalPattern[futureMonthIndex] + (m * futureMonthTotalIndex);
        predictedNDVI.push(Math.max(0, Math.min(1, prediction)));
        futureDates.push(futureDate);
      }
      const allDates = chartData.dates.concat(futureDates);
      const allNDVI = chartData.ndvi.concat(predictedNDVI);
      const lastHistoricalIndex = chartData.dates.length - 1;
      const ctx = document.getElementById('ndviChart').getContext('2d');

      if (myChart) {
        myChart.destroy();
      }
      myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: allDates.map(d => d.toLocaleString('default', { month: 'short', year: 'numeric' })),
          datasets: [{
            label: 'Historical NDVI',
            data: chartData.ndvi,
            borderColor: '#2ca02c',
            backgroundColor: 'rgba(44, 160, 44, 0.2)',
            pointBackgroundColor: '#2ca02c',
            borderWidth: 2,
            pointRadius: 3,
            fill: false,
            tension: 0.4
          },
          {
            label: 'Predicted NDVI',
            data: allNDVI,
            borderColor: '#ff7f0e',
            backgroundColor: 'rgba(255, 127, 14, 0.2)',
            pointBackgroundColor: '#ff7f0e',
            borderWidth: 2,
            pointRadius: 3,
            fill: false,
            borderDash: [5, 5],
            tension: 0.4,
            pointStyle: (context) => {
              const index = context.dataIndex;
              if (index <= lastHistoricalIndex) {
                return 'circle';
              } else {
                return 'star';
              }
            }
          }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: {
                display: true,
                text: 'Date',
                color: '#9ca3af'
              },
              ticks: {
                color: '#9ca3af',
                autoSkip: true,
                maxTicksLimit: 12
              },
              grid: {
                color: 'rgba(156, 163, 175, 0.1)'
              }
            },
            y: {
              title: {
                display: true,
                text: 'NDVI (Vegetation Index)',
                color: '#9ca3af'
              },
              min: 0,
              max: 1,
              ticks: {
                color: '#9ca3af'
              },
              grid: {
                color: 'rgba(156, 163, 175, 0.1)'
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: '#e5e7eb'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(31, 41, 55, 0.8)',
              titleColor: '#e5e7eb',
              bodyColor: '#9ca3af'
            }
          },
          onClick: handleChartClick
        }
      });

      const infoPanel = document.getElementById('data-visualization-info');
      infoPanel.innerHTML = `
                <h3 class="text-xl font-semibold text-white/90 mb-2">${locationName}</h3>
                <p class="text-gray-400">Click on a data point to get an AI prediction for that month.</p>
            `;
      const selectedMonthInfo = document.getElementById('selected-month-info');
      selectedMonthInfo.classList.add('hidden');
    }

    function handleChartClick(event) {
      const points = myChart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
      if (points.length) {
        const firstPoint = points[0];
        const label = myChart.data.labels[firstPoint.index];
        const value = myChart.data.datasets[0].data[firstPoint.index];

        selectedDataPointIndex = firstPoint.index;
        const selectedMonthInfo = document.getElementById('selected-month-info');
        const selectedMonthText = document.getElementById('selected-month-text');
        selectedMonthText.textContent = label;
        selectedMonthInfo.classList.remove('hidden');
      }
    }

    function getPredictionForSelectedMonth() {
      if (selectedDataPointIndex === null) {
        document.getElementById('ai-response-container').textContent = "Please select a month on the chart first.";
        return;
      }

      const selectedMonth = myChart.data.labels[selectedDataPointIndex];
      const selectedValue = myChart.data.datasets[0].data[selectedDataPointIndex];
      const aiResponseContainer = document.getElementById('ai-response-container');
      aiResponseContainer.innerHTML = `<div class="loader mx-auto"></div> <span class="block text-center mt-2 text-gray-400">Thinking...</span>`;
      setTimeout(() => {
        const location = currentLocation;
        let response = "";
        if (myChart.data.datasets[1].data[selectedDataPointIndex] !== undefined) {
          const predictedValue = myChart.data.datasets[1].data[selectedDataPointIndex];
          response = `For ${location}, the AI predicts a Normalized Difference Vegetation Index (NDVI) of approximately ${predictedValue.toFixed(2)} in ${selectedMonth}. This is a predicted value based on an analysis of past trends and seasonal cycles.`;
        } else {
          response = `For ${selectedMonth} in ${location}, the historical NDVI value was approximately ${selectedValue.toFixed(2)}. This value is a historical measurement from our satellite data.`;
        }

        aiResponseContainer.innerHTML = response;
      }, 1500);
    }

    window.onload = async () => {
      const chartStatus = document.getElementById('chart-status');
      const ndviChart = document.getElementById('ndviChart');
      const hdfFileInput = document.getElementById('hdf-file-input');
      const uploadStatusMessage = document.getElementById('upload-status-message');
      const getPredictionButton = document.getElementById('get-prediction-button');
      if (typeof Chart === 'undefined') {
        chartStatus.innerHTML = "Error: Chart.js failed to load. Please try again.";
        return;
      }

      try {
        chartStatus.textContent = "Fetching data...";
        fetchedNDVIData = await fetchDataAndLoad();
        chartStatus.textContent = "Data loaded.";
      } catch (error) {
        chartStatus.textContent = "Failed to load data. Please check the console for errors.";
        console.error("Initialization error:", error);
      }

      initializeGlobe(); // Initialize the globe
      createCountryButtons();
      updateGlobeText(0); // Initial globe update
      updateChart('Japan');

      if (getPredictionButton) {
        getPredictionButton.addEventListener('click', getPredictionForSelectedMonth);
      }
      slider.addEventListener("input", e => {
        updateGlobeText(parseInt(e.target.value));
      });
      setupPlayButton();

      hdfFileInput.addEventListener('change', (event) => {
        if (event.target.files.length > 0) {
          uploadStatusMessage.className = 'text-sm text-yellow-400 mt-2';
          uploadStatusMessage.textContent = 'Processing file...';
          setTimeout(() => {
            uploadStatusMessage.className = 'text-sm text-green-400 mt-2';
            uploadStatusMessage.textContent = 'File uploaded successfully. Simulating data visualization. Please select a location to see the updated chart.';
            updateChart(currentLocation);
          }, 2000);
        }
      });
    };
  </script>
</body>

</html>
